<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>KOMPASS (Konecta Operations, Management & Personnel Self-Service)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Using Inter, a calm and highly legible font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart', 'table']});
      google.charts.setOnLoadCallback(() => { chartsLoaded = true; }); 
    </script>
    
    <style>
      /* --- Color Palette & Variables --- */
      :root {
        /* --- NEW: App Loader --- */
      #app-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--page-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--border-color);
        border-top-color: var(--konecta-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      /* This keyframes rule is likely already in your CSS, but ensure it exists */
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
        /* Konecta Branding */
        --konecta-blue: #00a9e0;
        --konecta-dark: #2900c9; 
        --konecta-yellow: #f0fa00; 

        /* Core UI - LIGHT MODE */
        --text-color: #212121; 
        --text-color-secondary: #5f6368;
        --page-bg: #f4f7f6;
        --card-bg: #ffffff;
        --border-color: #e0e0e0;
        --input-bg: #f8f9fa;
        --shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        --radius: 12px;

        /* Role Colors (User-Defined) */
        --role-user-bg: #f4f7f6; 
        --role-admin-bg: #2900c9;
        --role-superadmin-bg: #2900c9;
        
        /* Status Colors (Unified) */
        --status-pending: #feefc3; 
        --status-pending-text: #744210;
        --status-login: #edfbf3; 
        --status-login-text: #2a6944;
        --status-break: #e6f4ff; 
        --status-break-text: #174b85;
        --status-leave: #fdebee; 
        --status-leave-text: #c53030;
      }

      /* DARK MODE OVERRIDES */
      body.dark-mode {
        --text-color: #f4f7f6;
        --text-color-secondary: #b0b0b0;
        --page-bg: #1e1e1e;
        --card-bg: #2d2d2d;
        --border-color: #444444;
        --input-bg: #3c3c3c;
        --shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        
        /* Adjusting role backgrounds for dark mode visibility */
        --role-user-bg: #252525; 
        --role-admin-bg: #252525;
        --role-superadmin-bg: #0d015c;
        
        /* Status Colors (Dark Mode) */
        --status-pending: #4b2a0c; 
        --status-pending-text: #f9da8a;
        --status-login: #1a4f2b; 
        --status-login-text: #b8e9c9;
        --status-break: #103a5c; 
        --status-break-text: #96c4e0;
        --status-leave: #7b1d1d; 
        --status-leave-text: #fbb2b2;
      }
      
      /* --- Global Transitions and Font --- */
      * {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        /* NEW: Custom Scrollbar for modern browsers */
        scrollbar-color: var(--konecta-dark) var(--page-bg); 
        scrollbar-width: thin; 
      }
      /* NEW: Webkit Scrollbar Styling (Chrome/Safari) */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--page-bg);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--konecta-dark);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--konecta-blue);
      }
      
      body, html {
        font-family: 'Inter', Arial, sans-serif;
        margin: 0; 
        padding: 0;
        background-color: var(--page-bg);
        color: var(--text-color);
        min-height: 100vh;
        
        /* NEW: Subtle Konecta Branding Background (Dots) */
        background-image: 
          radial-gradient(var(--border-color) 1px, transparent 1px),
          radial-gradient(var(--border-color) 1px, transparent 1px);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
      }
      
      /* Dark Mode Pattern Adjustment */
      body.dark-mode {
          /* Inherits dark mode vars */
          
          /* Adjusting pattern visibility for dark mode */
          background-image: 
            radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
            radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      }
      
      body {
        display: flex;
        flex-direction: column;
      }
      
      h1, h2, h3, h4, strong {
        color: var(--text-color);
      }
      
      /* --- Role-Based Body Background (The Revolution!) --- */
      body[data-role="agent"] main, body[data-role="agent"] header {
          background-color: var(--card-bg);
      }

      body[data-role="admin"] header {
        background-color: var(--role-admin-bg);
        border-color: var(--role-admin-bg);
      }
      body[data-role="admin"] header h1, body[data-role="admin"] header .header-kap {
        color: black;
      }
      body[data-role="admin"] main {
        border: 2px solid var(--role-admin-bg);
      }
      body[data-role="admin"] #admin-panel {
        background-color: var(--role-admin-bg);
        border-color: var(--role-admin-bg);
        color: black;
        box-shadow: 0 4px 10px rgba(var(--role-admin-bg), 0.3);
      }
      
      body[data-role="superadmin"] header {
        background-color: var(--role-superadmin-bg);
        border-color: var(--role-superadmin-bg);
      }
      body[data-role="superadmin"] header h1, body[data-role="superadmin"] header .header-kap {
        color: white;
      }
      body[data-role="superadmin"] main {
        border: 2px solid var(--role-superadmin-bg);
      }
      body[data-role="superadmin"] #admin-panel {
        background-color: var(--role-superadmin-bg);
        border-color: var(--role-superadmin-bg);
        color: white;
        box-shadow: 0 4px 10px rgba(var(--role-superadmin-bg), 0.3);
      }

      /* --- Header with Logo and Dark Mode Button --- */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 30px;
        background-color: var(--card-bg);
        border-bottom: 2px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .header-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      /* --- NEW: Header Brand Styling --- */
      .header-brand {
        display: flex;
        align-items: center;
        gap: 15px;
        /* This ensures it doesn't get pushed by controls on small screens */
        flex-shrink: 1; 
        overflow: hidden;
      }
      .logo-container {
        width: 175px; /* <-- Increased size again */
        height: 100px; /* <-- Increased size again */
        border-radius: 6px; /* Slightly more rounded */
        overflow: hidden;
        background-color: #2900ca; /* <-- Your requested background color */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        flex-shrink: 0; /* Don't shrink the logo */
      }
      .header-logo {
        width: 100%;
        height: 100%;
        object-fit: contain; /* <-- Use 'contain' for the new logo */
        padding: 6px; /* <-- This adds the 'filling' around the logo */
        box-sizing: border-box; /* <-- IMPORTANT: Keeps padding inside the box */
      }
      body.dark-mode .logo-container {
         box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Dark mode shadow */
      }
      
      header h1 { 
        color: var(--text-color);
        font-size: 1.8rem; /* Bigger */
        font-weight: 800; /* Bolder */
        margin: 0;
        display: flex;
        align-items: baseline; /* Align "KAP" and span baseline */
        white-space: nowrap; /* Prevent wrapping */
      }
      
      .header-kap {
        color: var(--konecta-blue);
        font-weight: 500; /* Lighter than KAP */
        font-size: 0.9rem; /* Smaller */
        margin-left: 8px;
      }
      /* --- END Header Brand Styling --- */
      
      /* --- Refresh Button (MODIFIED) --- */
      #header-refresh-button {
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        cursor: pointer;
        
        /* Set height to match toggle and width to be a square */
        height: 34px;
        width: 34px;
        padding: 0; /* Remove padding for exact size */
        
        /* Use the app's standard radius for a modern "squarish" look */
        border-radius: var(--radius); 

        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      #header-refresh-button:hover {
        opacity: 0.9;
        transform: scale(1.05);
        background-color: var(--page-bg);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      #header-role-request-button {
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        cursor: pointer;
        height: 34px;
        width: 34px;
        padding: 0;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        /* This display: none is the default, JS will show it */
        display: none; 
      }

      #header-role-request-button:hover {
        opacity: 0.9;
        transform: scale(1.05);
        background-color: var(--page-bg);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      #header-role-request-button img {
        width: 20px; 
        height: 20px;
      }
      #header-refresh-button img {
        /* Resize the new icon to fit inside the button */
        width: 20px; 
        height: 20px;
      }
      #header-refresh-button.loading img {
        animation: spin 1s linear infinite;
      }
      #header-role-request-button.loading img {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      #header-role-request-button {
         position: relative; /* Needed for the badge */
     }

     #header-role-request-button.has-notification::after {
       content: '';
       position: absolute;
       top: 5px;
      right: 5px;
       width: 10px;
       height: 10px;
       background-color: #ea4335; /* Red dot */
       border-radius: 50%;
       border: 2px solid var(--card-bg);
       box-shadow: 0 0 5px rgba(234, 67, 53, 0.8);
       animation: pulse 1.5s infinite;
     }

     @keyframes pulse {
       0% { transform: scale(0.95); }
       70% { transform: scale(1.1); }
       100% { transform: scale(0.95); }
          }
      /* --- Dark Mode Toggle Switch (NEW STYLES) --- */
      .dark-mode-toggle-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        height: 34px;
        margin-right: 5px;
      }

      #dark-mode-toggle {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .switch-label {
        position: relative;
        display: block;
        width: 60px;
        height: 34px;
        border-radius: 17px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .switch-label:before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: var(--konecta-blue);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      /* Icons inside the toggle */
      .sun-icon, .moon-icon {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        transition: opacity 0.3s ease;
      }

      .sun-icon {
        left: 8px;
        opacity: 1;
      }

      .moon-icon {
        right: 8px;
        opacity: 0;
      }

      /* Checked state (Dark Mode) */
      #dark-mode-toggle:checked + .switch-label:before {
        transform: translateX(26px);
        background-color: var(--konecta-dark);
      }

      #dark-mode-toggle:checked + .switch-label .sun-icon {
        opacity: 0;
      }

      #dark-mode-toggle:checked + .switch-label .moon-icon {
        opacity: 1;
      }
      /* --- END Dark Mode Toggle Switch --- */

      /* --- Centered Card Layout --- */
      main {
        max-width: 1800px;
        margin: 30px auto 0 auto; 
        background-color: var(--card-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        flex-grow: 1;
        transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); /* Slower, smoother shadow transition */
      }
      
      /* --- Tab Navigation --- */
      #tab-nav {
        border-bottom: 1px solid var(--border-color);
        padding-top: 10px;
        display: flex;
        justify-content: flex-start;
        overflow-x: auto;
        padding-left: 30px;
        background-color: var(--card-bg);
      }
      .tab-button {
        padding: 14px 15px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        background-color: transparent;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        color: var(--text-color-secondary);
        white-space: nowrap;
      }
      .tab-button:hover {
        background-color: var(--input-bg);
        color: var(--konecta-blue);
      }
      .tab-button.active {
        color: var(--konecta-blue);
        border-bottom: 3px solid var(--konecta-blue);
        background-color: var(--input-bg);
      }
      #schedule-tab-button, #leave-approval-tab-button, #history-report-tab-button, #dashboard-tab-button, #my-schedule-tab-button, #reporting-line-tab-button, #admin-tools-tab-button {
        display: none;
      }
      
      /* --- Content Container --- */
      .content-container {
        padding: 40px;
      }
      
      .tab-panel {
        display: none;
      }
      #punch-panel {
        display: block;
      }
      
      /* --- Info and Admin Panels --- */
      #agent-info { 
        margin-bottom: 20px; 
        padding: 15px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        text-align: center;
        font-size: 1.1em;
        position: relative; 
        transition: all 0.3s ease;
      }
      
      #admin-panel {
        display: none;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      #admin-panel label {
        font-weight: 600;
        margin-right: 10px;
        color: var(--text-color);
      }
      #agent-select {
        font-size: 1em;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
      }

      /* --- Punch Button Group --- */
      #buttons, #other-buttons {
        padding: 0;
        background-color: transparent;
        border-radius: 0;
        box-shadow: none;
        text-align: center;
      }
      #buttons, #other-buttons {
         display: none;
      }
      
      #other-buttons {
        margin-top: 20px;
      }

      button {
        margin: 10px;
        padding: 14px 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 10px;
        background-color: var(--konecta-blue);
        color: white;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 10px rgba(0, 169, 224, 0.3);
        transition: all 0.2s ease-out; 
        min-width: 160px;
      }
      button:hover {
        background-color: #008fbc;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 169, 224, 0.4);
      }
      
      #other-buttons button {
        background-color: var(--text-color-secondary);
        box-shadow: 0 4px 10px rgba(95, 99, 104, 0.2);
      }
       #other-buttons button:hover {
        background-color: #3c4043;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(95, 99, 104, 0.3);
      }
      
      .button-group {
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
      }
      .button-group:last-of-type {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }
      
      /* --- Alert/Status Styles --- */
      .status-message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        min-height: 30px;
        font-size: 1em;
        font-weight: 500;
        text-align: center;
        visibility: hidden;
        border: 1px solid transparent;
        opacity: 0;
        transition: opacity 0.4s ease, visibility 0.4s ease, transform 0.3s ease;
        transform: translateY(10px);
      }
      .status-message.visible {
        visibility: visible;
        opacity: 1;
        transform: translateY(0);
      }
      
      /* Base Style for all status containers */
      #status, #schedule-status, #leave-status, #approval-status, #my-history-status, #manual-punch-status, #admin-leave-status, #csv-import-status, #balance-adjust-status, #my-schedule-status, #dashboard-status, #reporting-line-status, #coaching-submit-status, #coaching-list-status, #admin-request-status, #supervisor-save-status, #registration-admin-status {
          /* Inherits status-message styles */
      }
      /* NEW: Added coaching statuses */
      #coaching-submit-status, #coaching-list-status {
          /* Inherits status-message styles */
      }


      /* Success */
      .status-message.success { 
        background-color: #edfbf3; 
        color: #2a6944; 
        border-color: #b8e9c9;
      }
      body.dark-mode .status-message.success { 
        background-color: #1a4f2b; 
        color: #b8e9c9;
        border-color: #2a6944;
      }

      /* Error */
      .status-message.error { 
        background-color: #fdebee; 
        color: #c53030; 
        border-color: #fbb2b2;
      }
      body.dark-mode .status-message.error { 
        background-color: #7b1d1d; 
        color: #fbb2b2;
        border-color: #c53030;
      }
      
      /* Processing/Warning */
      .status-message.processing { 
        background-color: #feefc3; 
        color: #744210; 
        border-color: #f9da8a;
      }
      body.dark-mode .status-message.processing { 
        background-color: #4b2a0c; 
        color: #f9da8a;
        border-color: #744210;
      }
      
      /* --- Form Styles (reusable) --- */
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-color-secondary);
      }
      .form-group select, .form-group input, .form-group textarea {
        width: 100%;
        padding: 12px;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-sizing: border-box;
        background-color: var(--input-bg);
        color: var(--text-color);
        font-family: 'Inter', Arial, sans-serif;
      }
      .form-group input[type="date"], .form-group input[type="time"] {
        /* Fixes date/time text alignment in some browsers in dark mode */
        color-scheme: var(--dark-mode-scheme, light); 
      }
      body.dark-mode {
        --dark-mode-scheme: dark;
      }
      .form-row {
        display: flex;
        gap: 15px;
      }
      .form-row .form-group {
        flex: 1;
      }
      
      .form-group small {
        display: block;
        margin-top: 6px;
        font-size: 0.85rem;
        color: var(--text-color-secondary);
      }
      
      .form-container .submit-btn-green {
        background-color: #34a853;
        box-shadow: 0 4px 10px rgba(52, 168, 83, 0.3);
      }
      .form-container .submit-btn-green:hover {
        background-color: #2c8c45;
        box-shadow: 0 6px 15px rgba(52, 168, 83, 0.4);
      }
      
      /* --- Leave Balance Display --- */
      #leave-balances {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
      }
      .balance-item {
        flex: 1;
        text-align: center;
      }
      .balance-item p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-color-secondary);
        font-weight: 500;
      }
      .balance-item .balance-days {
        font-size: 2rem;
        font-weight: 700;
        color: var(--konecta-blue);
        display: block;
        margin-top: 5px;
      }
      
      /* --- Leave List Styles (Reused for Dashboard Tables) --- */
      .request-list {
        margin-top: 30px;
        padding-top: 20px;
      }
      .request-list-item {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-left: 5px solid var(--konecta-blue);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        transition: all 0.3s ease;
      }
      .request-list-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      
      .request-list-item .item-details {
        flex: 1;
      }
      .request-list-item .item-details h4 {
        margin: 0 0 10px 0;
        color: var(--text-color);
        font-size: 1.1em;
      }
      .request-list-item .item-details p {
        margin: 4px 0;
        font-size: 0.95rem;
        color: var(--text-color-secondary);
      }
      .request-list-item .item-actions {
        min-width: 150px;
        text-align: right;
      }
      
      /* Status Badges */
      .status-badge {
        display: inline-block;
        padding: 6px 14px;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 20px;
        margin-top: 5px;
        text-transform: uppercase;
      }
      .status-pending { background-color: var(--status-pending); color: var(--status-pending-text); }
      .status-approved { background-color: var(--status-login); color: var(--status-login-text); }
      .status-denied { background-color: var(--status-leave); color: var(--status-leave-text); }

      /* NEW: Dashboard Agent Status Styles */
      .status-Logged-In { background-color: var(--status-login); color: var(--status-login-text); }
      .status-On-Break-Other { background-color: var(--status-break); color: var(--status-break-text); }
      .status-On-Leave { background-color: var(--status-leave); color: var(--status-leave-text); }
      .status-Absent { background-color: var(--status-leave); color: var(--status-leave-text); }
      .status-Pending-Login { background-color: var(--status-pending); color: var(--status-pending-text); }
      .status-Logged-Out { background-color: var(--status-leave); color: var(--status-leave-text); }
      
      .item-actions .approve-btn,
      .item-actions .deny-btn {
        min-width: 100px;
        padding: 8px 12px;
        font-size: 14px;
        margin: 4px;
        font-weight: 500;
        box-shadow: none;
        transform: none;
      }
      .approve-btn { background-color: #34a853; }
      .approve-btn:hover { background-color: #2c8c45; }
      .deny-btn { background-color: #ea4335; }
      .deny-btn:hover { background-color: #b92c2c; }
      
      /* --- Filter Buttons --- */
      #approval-filter-nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .filter-button {
        flex: 1;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-button:hover {
        background-color: var(--page-bg);
      }
      .filter-button.active {
        background-color: var(--konecta-blue);
        color: white;
        border-color: var(--konecta-blue);
      }
      
      /* --- History Report & Dashboard Form Layouts --- */
      #history-report-form {
        display: flex;
        flex-wrap: wrap; 
        gap: 15px;
        align-items: flex-end;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
      }
      #history-report-form .form-group {
        flex: 1;
        min-width: 150px; 
        margin-bottom: 0;
      }
      
      #history-report-form button {
        width: auto;
        min-width: 150px;
        margin: 0 0 0 10px;
        box-shadow: none;
        transform: none;
      }
      #history-report-form .view-btn {
        background-color: var(--konecta-dark);
      }
      #history-report-form .view-btn:hover {
        background-color: #1a0199;
        transform: translateY(-1px);
      }
      #history-report-form .export-btn {
        background-color: var(--text-color-secondary);
        display: none;
      }
      #history-report-form .export-btn:hover {
        background-color: #3c4043;
      }
      
      /* Dashboard Form Layout (MODIFIED) */
      #dashboard-form {
        display: flex;
        flex-wrap: wrap; 
        gap: 15px;
        align-items: flex-end;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
      }
      #dashboard-form .form-group {
        flex: 1;
        min-width: 150px; 
        margin-bottom: 0;
      }
      #dashboard-filters {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 180px;
      }
      #dashboard-filters button {
        width: 100%;
        margin: 0;
      }
      #dashboard-filters .load-btn { background-color: var(--konecta-dark); }
      #dashboard-filters .load-btn:hover { background-color: #1a0199; }
      #dashboard-filters .team-btn { background-color: #34a853; }
      #dashboard-filters .team-btn:hover { background-color: #2c8c45; }
      #dashboard-filters .save-btn { background-color: var(--konecta-blue); }
      #dashboard-filters .save-btn:hover { background-color: #008fbc; }
      
      /* --- Report Tables --- */
      #history-report-display, #my-schedule-display {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        overflow-x: auto; 
      }
      .report-table, .schedule-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      .report-table th, .report-table td, .schedule-table th, .schedule-table td {
        border: 1px solid var(--border-color);
        padding: 12px;
        text-align: left;
        color: var(--text-color);
      }
      .report-table th, .schedule-table th {
        background-color: var(--input-bg);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: var(--text-color-secondary);
      }
      
      .schedule-table .day-today {
        font-weight: 700;
        background-color: var(--konecta-yellow);
        color: black;
      }
      body.dark-mode .schedule-table .day-today {
        background-color: var(--role-admin-bg);
        color: white;
      }
      
      /* --- Dashboard Grid Restructure (MODIFIED) --- */
      #dashboard-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
          gap: 20px;
      }
      .dashboard-card {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      /* Ensure full width items span across all columns in the flexible grid */
      .dashboard-card.full-width {
        grid-column: 1 / -1;
      }
      .dashboard-card h3 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        color: var(--konecta-blue);
        font-size: 1.2rem;
      }
      .chart-container, .table-container {
        width: 100%;
        min-height: 350px;
        overflow-y: auto;
      }

      /* --- Section divider --- */
      .section-divider {
        border: 0;
        border-top: 1px solid var(--border-color);
        margin: 30px 0;
      }
      
      /* --- FOOTER STYLES (NEW/MODIFIED) --- */
      footer {
        padding: 15px 30px;
        margin-top: auto;
        text-align: center;
        width: 100%;
        background-color: var(--card-bg); 
        border-top: 1px solid var(--border-color); 
        box-sizing: border-box;
        color: var(--text-color-secondary); 
      }
      
      footer p {
        margin: 0;
        font-size: 0.9rem;
      }

      /* --- Dashboard Table Styling --- */
      
      /* Style container to look like approval list */
      .dashboard-list-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-top: 10px; 
      }
      
      /* Style item cards for Dashboard Details */
      .dashboard-detail-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-left: 5px solid var(--konecta-blue);
        border-radius: 8px;
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px 5px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      }
      .dashboard-detail-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .dashboard-detail-item .detail-label {
        font-weight: 500;
        color: var(--text-color-secondary);
        white-space: nowrap;
      }

      .dashboard-detail-item .detail-value {
        font-weight: 600;
        color: var(--text-color);
        grid-column: span 2;
        text-align: right;
      }
      
      /* Specific styling for the Pending Leave Table - matches approval list */
      .dashboard-leave-item {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-left: 5px solid #34a853;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 15px;
        transition: all 0.3s ease;
      }
      .dashboard-leave-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .dashboard-leave-item .item-details {
        flex: 1;
      }
      .dashboard-leave-item .item-details h4 {
        margin: 0 0 5px 0;
        color: var(--text-color);
        font-size: 1em;
      }
      .dashboard-leave-item .item-details p {
        margin: 2px 0;
        font-size: 0.9rem;
        color: var(--text-color-secondary);
      }
      
      /* NEW: Agent Status List Item */
      .agent-status-item {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease-in-out;
      }
      .agent-status-item:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .agent-status-item strong {
        font-size: 1rem;
        font-weight: 600;
      }
      .status-tag {
        padding: 5px 10px;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        border-radius: 9999px; /* Pill shape */
      }

      /* --- NEW: Custom Multi-Select Styles (History only) --- */
      /* Apply to both dashboard and history containers */
      #dashboard-user-select-container, #history-user-select-container {
        position: relative; 
      }

      .custom-select-button {
        width: 100%;
        padding: 12px;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--input-bg);
        color: var(--text-color);
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
        min-width: 150px;
        margin: 0; 
        box-shadow: none; 
        transform: none; 
      }
      .custom-select-button:hover {
        background-color: var(--page-bg);
        border-color: var(--konecta-blue);
      }

      .custom-select-button::after {
        content: '▼';
        font-size: 0.7em;
        transition: transform 0.2s;
        color: var(--text-color-secondary);
      }

      .custom-select-button.active::after {
        transform: rotate(180deg);
      }

      .custom-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 250px;
        overflow-y: auto;
        z-index: 50;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        display: none;
        margin-top: 5px;
        padding: 5px 0;
        color: var(--text-color);
      }
      
      /* Make sure checkboxes/labels look good in dark mode */
      .custom-select-dropdown input[type="checkbox"] {
          margin-right: 10px;
          cursor: pointer;
          accent-color: var(--konecta-blue);
          min-width: 18px;
          min-height: 18px;
      }
      .custom-select-dropdown label {
          color: var(--text-color);
          margin-bottom: 0;
      }

      .dropdown-item {
        padding: 8px 15px;
        cursor: pointer;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .dropdown-item:hover {
        background-color: var(--input-bg);
      }

      .dropdown-item.selected {
        background-color: var(--konecta-blue);
        color: white;
        font-weight: 600;
      }

      .dropdown-item.selected:hover {
        background-color: #008fbc;
      }
      .dropdown-item.selected label {
        color: white;
      }
      /* --- END Custom Multi-Select Styles --- */

      /* --- NEW: Hierarchy Tree View Styles --- */
      #dashboard-hierarchy-container {
          flex: 2;
          min-width: 300px;
      }
      #hierarchy-tree-view {
          padding: 10px;
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          background-color: var(--card-bg);
      }

      .tree-node {
          padding: 8px 5px;
          cursor: pointer;
          user-select: none;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.95rem;
          position: relative;
          border-left: 3px solid transparent;
          transition: all 0.2s ease;
      }
      .tree-node:hover {
          background-color: var(--input-bg);
          border-left-color: var(--konecta-blue);
          border-radius: 4px;
      }
      .tree-node.selected {
          background-color: var(--konecta-dark);
          color: white;
          font-weight: 600;
          border-left-color: var(--konecta-yellow);
      }
      .tree-node.selected span, .tree-node.selected img {
          filter: invert(1); 
      }
      .tree-node.selected .tree-label {
          color: white !important;
      }
      .tree-label {
          flex-grow: 1;
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .toggle-icon {
          width: 14px;
          height: 14px;
          transition: transform 0.2s;
          flex-shrink: 0;
          opacity: 0.7;
      }
      .collapsed .toggle-icon {
          transform: rotate(-90deg);
      }
      /* Hide toggle icon for nodes with no children */
      .tree-node[data-has-children="false"] .toggle-icon {
          visibility: hidden;
      }

      .subordinates-list {
          margin-left: 15px;
          padding-left: 5px;
          border-left: 1px solid var(--border-color);
          display: none;
      }
      
      /* --- NEW: Role Circles/Icons --- */
      .role-icon {
          width: 12px;
          height: 12px;
          border-radius: 50%;
          flex-shrink: 0;
          border: 1px solid transparent;
      }
      .role-icon.agent {
          background-color: var(--konecta-blue);
      }
      .role-icon.admin {
          background-color: var(--konecta-yellow);
          border-color: black;
      }
      .role-icon.superadmin {
          background-color: var(--konecta-dark);
      }
      /* End NEW Role Circles/Icons */
      /* --- END Hierarchy Tree View Styles --- */

      /* --- NEW: Coaching QA Form Styles --- */
      .qa-category {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--page-bg); /* Use page-bg for nested forms */
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
      }
      body.dark-mode .qa-category {
         background-color: var(--page-bg);
      }
      .qa-category h4 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        color: var(--konecta-blue);
      }
      .qa-criterion {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
      }
      .qa-criterion:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .qa-criterion p {
        margin: 0 0 8px 0;
        font-weight: 500;
        color: var(--text-color);
      }
      .qa-criterion-inputs {
        display: flex;
        gap: 15px;
      }
      .qa-criterion-inputs select {
        flex: 1;
        background-color: var(--card-bg); /* Use card-bg for inputs inside */
      }
      .qa-criterion-inputs textarea {
        flex: 2;
        height: 60px;
        min-height: 60px;
        background-color: var(--card-bg); /* Use card-bg for inputs inside */
      }
      #coaching-overall-score {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--konecta-dark);
        margin-top: 10px;
      }
      body.dark-mode #coaching-overall-score {
        color: var(--konecta-yellow);
      }
      
      /* NEW: Coaching list header style */
      .coaching-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: -20px; /* Pulls list up */
      }
      .coaching-list-header h2 {
         margin: 0;
      }
      /* Style for export button */
      .coaching-list-header .export-btn {
        background-color: var(--text-color-secondary);
        display: none; /* Hidden by default */
        margin: 0; /* Reset button margin */
        padding: 10px 20px; /* Smaller padding */
        font-size: 14px;
      }
      .coaching-list-header .export-btn:hover {
        background-color: #3c4043;
      }

      /* [START] MODIFICATION: CSS for Coaching Admin */
.template-category-block {
  background-color: var(--page-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 15px;
  margin-bottom: 20px;
  position: relative;
}
.template-category-block input {
  background-color: var(--card-bg);
}
.template-criteria-container {
  padding-left: 20px;
  border-left: 2px solid var(--konecta-blue);
  margin-top: 15px;
}
.template-criteria-item {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}
.template-criteria-item input {
  flex: 1;
}
.template-criteria-item .remove-btn, .remove-category-btn {
  padding: 8px 12px;
  font-size: 1rem;
  min-width: 40px;
  margin: 0;
  background-color: #ea4335;
  box-shadow: none;
  font-weight: 700;
  line-height: 1;
}
.remove-category-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: transparent;
  color: #ea4335;
  font-size: 1.2rem;
}
.remove-category-btn:hover {
  background-color: var(--status-leave);
}
/* [END] MODIFICATION */



      /* --- Responsive Design --- */
      @media (max-width: 900px) {
        .header-kap {
          display: none; /* Hide full title on small screens */
        }
        .header-brand {
          gap: 10px; /* Reduce gap */
        }
        /* Dashboard grid defaults to 1 column due to minmax(350px) but we explicitly set it for clarity */
        #dashboard-grid {
          grid-template-columns: 1fr;
        }
        .dashboard-card.full-width {
          grid-column: auto;
        }
        .form-row, #history-report-form, #dashboard-form {
          flex-direction: column;
          align-items: stretch;
        }
        #history-report-form button, #dashboard-filters button {
          margin: 10px 0 0 0;
        }
        #history-report-form .form-group, #dashboard-form .form-group {
          min-width: 100%;
        }
        main {
          margin: 15px;
        }
        header {
          padding: 15px 20px;
        }
        .content-container {
          padding: 20px;
        }
        #tab-nav {
          padding-left: 20px;
        }
        .request-list-item {
            flex-direction: column;
            align-items: stretch;
        }
        .request-list-item .item-actions {
            text-align: left;
            margin-top: 10px;
        }
        
        .dashboard-detail-item {
           /* On small screens, stack details better */
           grid-template-columns: 1fr 1fr;
        }
        .dashboard-detail-item .detail-value {
           grid-column: span 1;
           text-align: left;
        }
        
        #dashboard-hierarchy-container {
             flex: none;
        }
        /* NEW: Responsive QA Form */
        .qa-criterion-inputs {
          flex-direction: column;
        }
        /* NEW: Responsive coaching header */
        .coaching-list-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
          margin-bottom: 0;
        }
        .coaching-list-header .export-btn {
          width: 100%;
        }
      }
      /* --- FIX: Add padding to admin panels --- */
        #registration-admin-panel,
       #announcements-admin-panel {
         padding: 40px;
       }

       /* Responsive fix for small screens */
       @media (max-width: 900px) {
         #registration-admin-panel,
         #announcements-admin-panel {
           padding: 20px;
         }
       }

       /* --- Add this rule anywhere inside your <style> tag --- */
      button:disabled {
        background-color: var(--text-color-secondary);
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

    </style>
  </head>
  <body>
    <div id="app-loader">
      <div class="spinner"></div>
    </div>
    <header>
      <div class="header-brand">
        <div class="logo-container">
          <img class="header-logo" src="https://konecta.com/images/konecta-share.jpg" alt="Konecta Logo">
        </div>
        <h1>KOMPASS <span class="header-kap">Konecta Operations, Management & Personnel Self-Service</span></h1>
      </div>

      <div class="header-controls">
        
        <div class="dark-mode-toggle-wrapper" title="Toggle Dark Mode">
            <input type="checkbox" id="dark-mode-toggle">
            <label for="dark-mode-toggle" class="switch-label">
                <span class="sun-icon">⚫</span>
                <span class="moon-icon">⚪</span>
            </label>
        </div>
        
        <button id="header-refresh-button" title="Refresh Data" onclick="refreshCurrentData()">
          <img id="refresh-icon" src="https://cdn-icons-png.flaticon.com/512/2725/2725164.png" alt="Refresh Icon">
        </button>

        <button id="header-role-request-button" title="Request Role Upgrade" onclick="showRoleRequestModal()">
          <img id="role-request-icon" src="https://cdn1.iconfinder.com/data/icons/phishing-3/64/security_system_computer_padlock_system_lock_shield_phishing-1024.png" alt="Upgrade Icon">
        </button>
      </div>
    </header>

    <main>
      <div id="tab-nav">
        <button id="dashboard-tab-button" class="tab-button" onclick="showTab('dashboard')">Dashboard</button>
        <button id="punch-tab-button" class="tab-button active" onclick="showTab('punch')">Punch Clock</button>
        <button id="my-schedule-tab-button" class="tab-button" onclick="showTab('my-schedule')">My Schedule</button>
        <button id="leave-request-tab-button" class="tab-button" onclick="showTab('leave-request')">My Leave</button> 
        <button id="leave-approval-tab-button" class="tab-button" onclick="showTab('leave-approval')">Approvals</button>
        <button id="history-report-tab-button" class="tab-button" onclick="showTab('history-report')">History Report</button>
        <button id="schedule-tab-button" class="tab-button" onclick="showTab('schedule')">Schedule Editor</button>
        <button id="admin-tools-tab-button" class="tab-button" onclick="showTab('admin-tools')">Admin Tools</button>
        <button id="reporting-line-tab-button" class="tab-button" onclick="showTab('reporting-line')">Reporting Line</button>
        <button id="coaching-tab-button" class="tab-button" onclick="showTab('coaching')">Coaching</button>
        <button id="coaching-admin-tab-button" class="tab-button" onclick="showTab('coaching-admin')" style="display: none;">Coaching Admin</button>
        <button id="registration-admin-tab-button" class="tab-button" onclick="showTab('registration-admin')" style="display: none;">Registration Admin</button>
        <button id="announcements-admin-tab-button" class="tab-button" onclick="showTab('announcements-admin')" style="display: none;">Announcements</button>

      </div>

      <div class="content-container">

        <!-- ================================== -->
        <!--      TAB 1: PUNCH PANEL            -->
        <!-- ================================== -->
        <div id="punch-panel" class="tab-panel">

          <div id="announcement-banner-container" style="display: none; margin-bottom: 20px;">
            <div id="announcement-banner" class="status-message processing" style="visibility: visible; opacity: 1; text-align: left; padding-right: 35px; position: relative; border-color: var(--status-pending-text);">
              <strong style="display: block; margin-bottom: 5px; color: var(--status-pending-text);">Announcements</strong>
              <div id="announcement-content-area"></div>
              <button onclick="dismissAnnouncements()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; color: var(--status-pending-text); cursor: pointer; padding: 0; margin: 0; line-height: 1;">&times;</button>
            </div>
          </div>

          <div id="agent-info">Loading user info...</div> 
          <div id="admin-panel"><label for="agent-select">Punch For:</label><select id="agent-select"></select></div>

          <div id="current-status-display" class="status-message" style="visibility: visible ; text-align: left; font-size: 1.1rem; border-left-width: 5px; margin-top: 0; margin-bottom: 20px;">
            </div>
          <div id="status" class="status-message"></div>
          <div id="buttons">
            <div class="button-group"><button onclick="punch('Login')">Login</button></div>
            <div class="button-group"><button onclick="punch('First Break In')">1st Break In</button><button onclick="punch('First Break Out')">1st Break Out</button></div>
            <div class="button-group"><button onclick="punch('Lunch In')">Lunch In</button><button onclick="punch('Lunch Out')">Lunch Out</button></div>
            <div class="button-group"><button onclick="punch('Last Break In')">Last Break In</button><button onclick="punch('Last Break Out')">Last Break Out</button></div>
            <div class="button-group"><button onclick="punch('Logout')">Logout</button></div>
          </div>
          <div id="other-buttons">
             <div class="button-group"><button onclick="punch('Coaching In')">Coaching In</button><button onclick="punch('Coaching Out')">Coaching Out</button></div>
            <div class="button-group"><button onclick="punch('Meeting In')">Meeting In</button><button onclick="punch('Meeting Out')">Meeting Out</button></div>
             <div class="button-group"><button onclick="punch('Personal In')">Personal In</button><button onclick="punch('Personal Out')">Personal Out</button></div>
          </div>
          </div>

        <!-- ================================== -->
        <!--      TAB 2: MY SCHEDULE PANEL      -->
        <!-- ================================== -->
        <div id="my-schedule-panel" class="tab-panel">
          <h2 id="my-schedule-title">My Upcoming Schedule</h2>
          <p>Your schedule for the next 7 days.</p>
          <div id="my-schedule-status" class="status-message"></div>
          <div id="my-schedule-display"></div>
        </div>

        <!-- ================================== -->
        <!--     TAB 3: MY LEAVE PANEL          -->
        <!-- ================================== -->
        <div id="leave-request-panel" class="tab-panel">
          <h2>My Balances</h2>
          <div id="leave-balances">
            <div class="balance-item"><p>Annual</p><span class="balance-days" id="balance-annual">--</span></div>
            <div class="balance-item"><p>Sick</p><span class="balance-days" id="balance-sick">--</span></div>
            <div class="balance-item"><p>Casual</p><span class="balance-days" id="balance-casual">--</span></div>
          </div>

          <form id="leave-form" class="form-container">
            <h2>Submit Leave Request</h2>
            <div class="form-group"><label for="leave-type">Leave Type</label>
            <select id="leave-type" onchange="toggleSickNoteField()"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
            <div class="form-row">
              <div class="form-group"><label for="leave-start-date">Start Date</label><input type="date" id="leave-start-date" required></div>
              <div class="form-group"><label for="leave-end-date">End Date</label><input type="date" id="leave-end-date"><small>Leave blank for a single-day request.</small></div>
            </div>
            <div class="form-group"><label for="leave-reason">Reason (Optional)</label><textarea id="leave-reason" rows="3"></textarea></div>
            <div id="sick-note-upload-group" class="form-group" style="display: none;">
              <label for="sick-note-file">Upload Sick Note (PDF Required)</label>
              <input type="file" id="sick-note-file" class="form-group" accept=".pdf" style="border: none; padding: 0;">
              <small>This is mandatory for all 'Sick' leave requests.</small>
            </div>
            
            <button type="button" class="submit-btn-green" onclick="submitLeaveRequest()">Submit Request</button>
          </form>
          <div id="leave-status" class="status-message"></div>
          <div class="request-list">
            <h2>My Request History</h2>
            <div id="my-requests-list" class="request-list"></div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    TAB 4: HISTORY REPORT PANEL     -->
        <!-- ================================== -->
        <div id="history-report-panel" class="tab-panel">
          <h2>Adherence History Report</h2>
          <form id="history-report-form" class="form-container">
            <!-- MODIFIED: Replaced standard select with custom multi-select structure -->
            <div class="form-group" id="history-user-select-container" style="display: none;">
              <label>Select User(s)</label>
              <button type="button" id="custom-history-select-button" class="custom-select-button" onclick="toggleUserDropdown('history', event)">
                Select Users (0 selected)
              </button>
              <div id="custom-history-select-dropdown" class="custom-select-dropdown" onclick="event.stopPropagation()">
                <!-- Options will be dynamically populated here -->
              </div>
            </div>
            <div class="form-group">
              <label for="history-start-date">Start Date</label>
              <input type="date" id="history-start-date" required>
            </div>
            <div class="form-group">
              <label for="history-end-date">End Date</label>
              <input type="date" id="history-end-date" required>
            </div>
            <button type="button" class="view-btn" onclick="loadHistoryReport()">View History</button>
            <button type="button" class="export-btn" id="export-csv-btn" onclick="exportHistoryToCSV()">Export to CSV</button>
          </form>
          
          <div id="my-history-status" class="status-message"></div>
          <div id="history-report-display">
             <p class="text-color-secondary">Select users and dates, then click "View History" to generate the report.</p>
          </div>
        </div>

        <!-- ================================== -->
        <!--    TAB 5: SCHEDULE EDITOR PANEL    -->
        <!-- ================================== -->
        <div id="schedule-panel" class="tab-panel">
          
          <form id="csv-import-form" class="form-container">
            <h2>Bulk Schedule Importer (CSV)</h2>
            
            <p class="text-color-secondary" style="text-align: left; max-width: 600px; margin: 0 auto 15px auto; padding: 10px; background-color: var(--page-bg); border-radius: 8px;">
              <strong>Upload a CSV with the following headers:</strong>
              <br>
              <code>Name</code>, <code>StartDate</code>, <code>ShiftStartTime</code>, <code>EndDate</code>, <code>ShiftEndTime</code>, <code>LeaveType</code>, <code>agent email</code>
              <br><br>
              <ul style="margin: 0 0 0 20px; padding: 0; font-size: 0.9rem;">
                <li><strong><code>Name</code> (Required):</strong> The user's full name.</li>
                <li><strong><code>StartDate</code> (Required):</strong> Date of the shift (format: MM/dd/yyyy).</li>
                <li><strong><code>ShiftStartTime</code>:</strong> Required if <code>LeaveType</code> is "Present" (format: HH:mm).</li>
                <li><strong><code>EndDate</code> (Optional):</strong> Only fill this if the shift ends on a different calendar day (e.g., for an overnight shift).</li>
                <li><strong><code>ShiftEndTime</code>:</strong> Required if <code>LeaveType</code> is "Present" (format: HH:mm).</li>
                <li><strong><code>LeaveType</code>:</strong> Use "Present" for a work day. For any other value (e.g., "Sick", "Annual", "Day Off"), the times will be ignored.</li>
                <li><strong><code>agent email</code> (Required):</strong> The user's unique email address.</li>
              </ul>
            </p>
            <button 
              type="button" 
              class="view-btn" 
              style="background-color:var(--text-color-secondary); margin-bottom: 20px; max-width: 300px; align-self: center;" 
              onclick="downloadScheduleTemplate()">
              Download CSV Template
            </button>
            <div class="form-group">
              <label for="csv-file-input">Select CSV File</label>
              <input type="file" id="csv-file-input" accept=".csv">
            </div>
            <button type="button" style="background-color:var(--konecta-dark)" onclick="importScheduleCSV()">Import CSV</button>
          </form>
          <div id="csv-import-status" class="status-message"></div>
          
          <hr class="section-divider">
          
          <form id="schedule-form" class="form-container">
            <h2>Manual Schedule Editor</h2>
            <div class="form-group"><label for="schedule-agent-select">User</label><select id="schedule-agent-select"></select></div>
            <div class="form-row">
              <div class="form-group"><label for="schedule-start-date">Start Date</label><input type="date" id="schedule-start-date" required></div>
              <div class="form-group"><label for="schedule-end-date">End Date (Optional)</label><input type="date" id="schedule-end-date"><small>Leave blank to submit for a single day.</small></div>
            </div>
            <div class="form-group"><label for="schedule-leave-type">Leave Type / Status</label><select id="schedule-leave-type" onchange="toggleTimeFields()"><option value="Present">Present</option><option value="Sick">Sick</option><option value="Annual">Annual</option><option value="Casual">Casual</option><option value="Absent">Absent</option><option value="Day Off">Day Off</option></select></div>
            
            <div id="time-fields" class="form-row">
              <div class="form-group">
                <label for="schedule-start-time">Shift Start Time</label>
                <input type="time" id="schedule-start-time">
              </div>
              <div class="form-group">
                <label for="schedule-end-date-shift">Shift End Date</label>
                <input type="date" id="schedule-end-date-shift">
                <small>Only fill if shift ends on a different day.</small>
              </div>
              <div class="form-group">
                <label for="schedule-end-time">Shift End Time</label>
                <input type="time" id="schedule-end-time">
              </div>
            </div>
            <button type="button" class="submit-btn-green" onclick="submitSchedule()">Submit Schedule(s)</button>
          </form>
          <div id="schedule-status" class="status-message"></div>
        </div>
        
        <!-- ================================== -->
        <!--   TAB 6: LEAVE APPROVALS PANEL     -->
        <!-- ================================== -->
        <div id="leave-approval-panel" class="tab-panel">
  <h2>Leave Request Management</h2>
  <form id="leave-report-form" class="form-container" style="background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
    <div class="form-group" style="flex: 2; min-width: 200px; margin-bottom: 0;">
      <label for="leave-report-user">Select User</label>
      <select id="leave-report-user">
        </select>
    </div>
    <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
      <label for="leave-report-status">Select Status</label>
      <select id="leave-report-status">
        <option value="Pending">Pending</option>
        <option value="Approved">Approved</option>
        <option value="Denied">Denied</option>
        <option value="All">All</option>
      </select>
    </div>
    <button type="button" class="view-btn" onclick="loadLeaveReport()" style="margin: 0; background-color:var(--konecta-dark)">Load Requests</button>
  </form>

  <div id="approval-status" class="status-message"></div>
  <div id="pending-requests-list" class="request-list"></div>
</div>
        
        <!-- ================================== -->
        <!--     TAB 7: ADMIN TOOLS PANEL       -->
        <!-- ================================== -->
        <div id="admin-tools-panel" class="tab-panel">
          <form id="manual-punch-form" class="form-container">
            <h2>Manual Punch Editor</h2>
            <p class="text-color-secondary">Manually add or overwrite a punch for a user. This will bypass duplicate/sequential checks and recalculate metrics.</p>
            <div class="form-group"><label for="manual-punch-user">User</label><select id="manual-punch-user" required></select></div>
            <div class="form-group"><label for="manual-punch-action">Punch Action</label><select id="manual-punch-action" required><option value="">-- Select an action --</option><optgroup label="Adherence"><option value="Login">Login</option><option value="First Break In">First Break In</option><option value="First Break Out">First Break Out</option><option value="Lunch In">Lunch In</option><option value="Lunch Out">Lunch Out</option><option value="Last Break In">Last Break In</option><option value="Last Break Out">Last Break Out</option><option value="Logout">Logout</option></optgroup><optgroup label="Other Codes"><option value="Coaching In">Coaching In</option><option value="Coaching Out">Coaching Out</option><option value="Meeting In">Meeting In</option><option value="Meeting Out">Meeting Out</option><option value="Personal In">Personal In</option><option value="Personal Out">Personal Out</option></optgroup></select></div>
            <div class="form-row"><div class="form-group"><label for="manual-punch-date">Date of Punch</label><input type="date" id="manual-punch-date" required></div><div class="form-group"><label for="manual-punch-time">Time of Punch</label><input type="time" id="manual-punch-time" required></div></div>
            <button type="button" onclick="submitManualPunch()" style="background-color:var(--konecta-dark)">Submit Manual Punch</button>
          </form>
          <div id="manual-punch-status" class="status-message"></div>
          
          <hr class="section-divider">
          
          <div id="balance-adjustment-section" style="display: none;"> 
             <form id="balance-adjustment-form" class="form-container">
              <h2>Leave Balance Management</h2>
              <p class="text-color-secondary">Manually adjust a user's leave balance. Use a positive number (e.g., 2) to add days, and a negative number (e.g., -1) to remove days.</p>
              <div class="form-group"><label for="balance-user-select">Select User</label><select id="balance-user-select" required></select></div>
              <div class="form-row">
                <div class="form-group"><label for="balance-leave-type">Leave Type</label><select id="balance-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
                <div class="form-group"><label for="balance-amount">Amount to Adjust</label><input type="number" id="balance-amount" step="0.5" placeholder="e.g., -1 or 1.5" required></div>
              </div>
              <div class="form-group"><label for="balance-reason">Reason for Adjustment</label><textarea id="balance-reason" rows="2" required></textarea></div>
              <button type="button" style="background-color:var(--konecta-yellow); color:black;" onclick="submitBalanceAdjustment()">Submit Balance Adjustment</button>
            </form>
            <div id="balance-adjust-status" class="status-message"></div>
          </div>
          <hr class="section-divider">
          
          <form id="admin-leave-form" class="form-container">
            <h2>Submit Leave on Behalf of User</h2>
            <p class="text-color-secondary">Submit a leave request for a user. This will check their balance and send it to their assigned supervisor for approval.</p>
            <div class="form-group"><label for="admin-leave-user">Select User</LabeL><select id="admin-leave-user" required></select></div>
            <div class="form-group"><label for="admin-leave-type">Leave Type</label><select id="admin-leave-type"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Casual">Casual</option></select></div>
            <div class="form-row"><div class="form-group"><label for="admin-leave-start-date">Start Date</label><input type="date" id="admin-leave-start-date" required></div><div class="form-group"><label for="admin-leave-end-date">End Date</label><input type="date" id="admin-leave-end-date"><small>Leave blank for a single-day request.</small></div></div>
            <div class="form-group"><label for="admin-leave-reason">Reason (Optional)</label><textarea id="admin-leave-reason" rows="3"></textarea></div>
            <button type="button" class="submit-btn-green" onclick="submitAdminLeaveRequest()">Submit Request for User</button>
          </form>
          
          <div id="admin-leave-status" class="status-message"></div>
        </div>

        <!-- ================================== -->
        <!--     TAB 8: DASHBOARD PANEL         -->
        <!-- ================================== -->
        <div id="dashboard-panel" class="tab-panel">
          <h2 id="dashboard-title">Team Dashboard</h2>
          <div id="dashboard-controls" class="form-container">
            <form id="dashboard-form">
              <!-- NEW: Hierarchy Selection -->
              <div class="form-group" id="dashboard-hierarchy-container">
                <label>Team Hierarchy (Click user to select)</label>
                <div id="hierarchy-tree-view">
                  <p class="text-color-secondary">Loading team structure...</p>
                </div>
                <small class="text-color-secondary">Selected: <strong id="selected-user-display">None</strong></small>
              </div>
              
              <div class="form-group">
                <label for="dashboard-date">Select Date</label>
                <input type="date" id="dashboard-date" required>
              </div>
              
              <div id="dashboard-filters">
                <button type="button" class="load-btn" onclick="loadDashboard()">Load Dashboard for Selected User</button>
                <button type="button" class="team-btn" onclick="loadMyFullHierarchy()">Load My Full Hierarchy</button>
                <button type="button" class="save-btn" onclick="saveCurrentSelection()">Save Current Selection</button>
              </div>
            </form>
          </div>
          <div id="dashboard-status" class="status-message"></div>
          
          <hr class="section-divider">
          
          <!-- MODIFIED: The grid is now responsive with 2 columns on desktop -->
          <div id="dashboard-grid">
            <!-- MODIFIED: Added full-width class and removed the second card to make Agent Status fill the top row -->
            <div class="dashboard-card full-width">
              <!-- MODIFIED: Changed the title to reflect the new list display -->
              <h3>Agent Status (Real-Time)</h3>
              <!-- MODIFIED: This now holds the list of agents and their statuses -->
              <div id="status-agent-list" class="chart-container"></div>
            </div>
            <!-- Removed 'Total Adherence Deviations' card -->
            <div class="dashboard-card full-width">
              <h3>Adherence Details (Today)</h3>
              <!-- MODIFIED: Changed the container to display list-style cards -->
              <div id="adherence-detail-table" class="dashboard-list-container"></div>
            </div>
            <div class="dashboard-card full-width">
              <h3>Pending Leave Requests (for selected users)</h3>
              <!-- MODIFIED: Changed the container to display list-style cards -->
              <div id="pending-leave-table" class="dashboard-list-container"></div>
            </div>
          </div>
        </div>
        
        <!-- ================================== -->
        <!--    NEW TAB 9: REPORTING LINE       -->
        <!-- ================================== -->
        <div id="reporting-line-panel" class="tab-panel">

          <div id="pending-movements-section">
            <h2>Pending Reporting Line Approvals</h2>
            <p class="text-color-secondary">This section shows requests for you to approve, or requests pending for admins who report to you.</p>
            <div id="movement-approval-status" class="status-message"></div>
            <div id="pending-movements-list" class="request-list">
              <p class="text-color-secondary">Loading pending approvals...</p>
            </div>
          </div>
          
          <hr class="section-divider">

          <form id="reporting-line-form" class="form-container">
            <h2>Submit New Movement Request</h2>
            <p class="text-color-secondary">Select a user and their new supervisor. This will send a request to the new supervisor for approval.</p>
            
            <div class="form-group">
              <label for="reporting-line-user">Select User to Move</label>
              <select id="reporting-line-user" required></select>
            </div>
            
            <div class="form-group">
              <label for="reporting-line-supervisor">Assign to New Supervisor</label>
              <select id="reporting-line-supervisor" required></select>
            </div>
            
            <button type="button" onclick="submitMovementRequest()" style="background-color:var(--konecta-dark)">Submit Movement Request</button>
          </form>
          <div id="movement-request-status" class="status-message"></div>

          <hr class="section-divider">

          <div id="movement-history-section">
            <h2>User Movement History</h2>
            <p classs="text-color-secondary">Select one of your subordinates to view their complete movement history.</p>
            <form id="movement-history-form" class="form-container" style="background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
              <div class="form-group" style="flex: 2; min-width: 200px; margin-bottom: 0;">
                <label for="movement-history-user">Select User</label>
                <select id="movement-history-user">
                  </select>
              </div>
              <button type="button" class="view-btn" onclick="loadMovementHistory()" style="margin: 0; background-color:var(--konecta-dark)">Load History</button>
            </form>
            <div id="movement-history-status" class="status-message"></div>
            <div id="movement-history-list" class="request-list" style="margin-top: 20px;">
              <p class="text-color-secondary">Select a user to view their movement history.</p>
            </div>
          </div>

        </div>

        <!-- ================================== -->
        <!--    NEW TAB 10: COACHING PANEL      -->
        <!-- ================================== -->
        <div id="coaching-panel" class="tab-panel">
          
          <!-- Form Container (Now controlled by JS) -->
          <div id="coaching-form-container" class="form-container" style="display: none;">
            <h2>Submit New Coaching</h2>
            <div class="form-group">
              <label for="coaching-agent-select">Select User</label>
              <select id="coaching-agent-select" required></select>
            </div>
            <div class="form-group">
              <label for="coaching-template-select">Select Coaching Template</label>
              <select id="coaching-template-select" required onchange="loadCoachingForm()">
                <option value="">-- Select a template --</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="coaching-session-date">Session Date</label>
                <input type="date" id="coaching-session-date" required>
              </div>
              <div class="form-group">
                <label for="coaching-week-number">Week Number</label>
                <input type="text" id="coaching-week-number" readonly>
              </div>
            </div>
            
            <!-- Quality Score Section -->
            <h3>Quality Score
              <span id="coaching-overall-score" style="float: right;"></span>
            </h3>
            <div id="quality-score-form">
              <!-- JS will populate this -->
            </div>
            
            <hr class="section-divider">

            <div class="form-group">
              <label for="coaching-follow-up">Follow-up / Comments</label>
              <textarea id="coaching-follow-up" rows="4"></textarea>
            </div>
            
            <!-- *** NEW: Follow-up Date Input *** -->
            <div class="form-group">
              <label for="coaching-follow-up-date">Follow-up Date (Optional)</label>
              <input type="date" id="coaching-follow-up-date">
            </div>
            <!-- ******************************* -->
            
            <button type="button" class="submit-btn-green" onclick="submitNewCoaching()">Submit Coaching</button>
            <div id="coaching-submit-status" class="status-message"></div>
          </div>

          <!-- List Container -->
          <div id="coaching-list-container">
            <!-- *** NEW: Header container for Title and Export Button *** -->
            <div class="coaching-list-header">
              <h2>My Coaching History</h2> <!-- Title will be changed by JS -->
              <button type="button" class="export-btn" id="export-coaching-btn" onclick="exportCoachingHistory()">Export History</button>
            </div>
            <!-- ******************************************************* -->
            
            <div id="coaching-list-status" class="status-message"></div>
            <div id="coaching-list" class="request-list">
              <p class="text-color-secondary">Your coaching history will appear here.</p>
            </div>
          </div>
          </div>
          <!-- ================================== -->
          <!--      TAB 11: coaching admin PANEL            -->
          <!-- ================================== -->
          <div id="coaching-admin-panel" class="tab-panel" style="display:none;">
          <form id="template-create-form" class="form-container">
            <h2>Create New Coaching Template</h2>
            <p class="text-color-secondary">Create a new template. Add categories and criteria below. All fields are required.</p>
            
            <div class="form-group">
              <label for="template-name">Template Name</label>
              <input type="text" id="template-name" placeholder="e.g., 'Q1 Sales Template'" required>
            </div>
            
            <div id="template-categories-container">
              </div>
            
            <button type="button" class="view-btn" onclick="addTemplateCategory()" style="background-color:var(--konecta-blue); margin: 10px 0;">+ Add Category</button>
            <hr class="section-divider">
            <button type="button" class="submit-btn-green" onclick="saveNewTemplate()">Save New Template</button>
          </form>
          <div id="coaching-admin-status" class="status-message">
        </div>


        </div>

      </div>
      <div id="registration-admin-panel" class="tab-panel">
          <h2>New User Registrations</h2>
          <p class="text-color-secondary">Approve or deny new users who have registered and selected their supervisor. Approving them will activate their account.</p>
          <div id="registration-admin-status" class="status-message"></div>
          <div id="registration-admin-list" class="request-list">
            </div>
        </div>
        </div>
        
        <div id="announcements-admin-panel" class="tab-panel">
          <h2>Manage Announcements</h2>
          <p class="text-color-secondary">Create, edit, or delete announcements that appear on the Punch Clock.</p>

          <form id="announcement-form" class="form-container">
            <input type="hidden" id="announcement-id" value="">
            <div class="form-group">
              <label for="announcement-content">Announcement Content</label>
              <textarea id="announcement-content" rows="3" placeholder="Enter announcement text..."></textarea>
            </div>
            <div class="form-group">
              <label for="announcement-status">Status</label>
              <select id="announcement-status">
                <option value="Active">Active (Show to users)</option>
                <option value="Archived">Archived (Hide from users)</option>
              </select>
            </div>
            <button type="button" class="submit-btn-green" onclick="saveAnnouncement()">Save Announcement</button>
            <button type="button" class="view-btn" style="background-color:var(--text-color-secondary)" onclick="clearAnnouncementForm()">Clear Form</button>
          </form>
          <div id="announcement-admin-status" class="status-message"></div>

          <hr class="section-divider">

          <h3>Existing Announcements</h3>
          <div id="announcement-admin-list" class="request-list">
            <p class="text-color-secondary">Loading announcements...</p>
          </div>
        </div>
        
      
    </main> <!-- End .card -->

    <!-- MODIFIED: Footer is now positioned by CSS/Flexbox -->
    <footer>
      <p>KOMPASS (Konecta Operations, Management & Personnel Self-Service) - Created by Fady Bekhet</p>
    </footer>


    <script>
      const PLANNED_BREAK_SECONDS = 15 * 60; // 15 minutes
      const PLANNED_LUNCH_SECONDS = 30 * 60; // 30 minutes
      let selfUserName = ""; 
      let selfRole = "agent"; 
      let allUsersList = []; 
      let allAdminsList = []; 
      let lastHistoryData = null;
      let chartsLoaded = false; 
      
      // NEW: Global state for the custom multiselects (History only)
      let selectedHistoryUsers = {};
      let historyUserList = [];
      
      // NEW: Global state for Dashboard Hierarchy
      let managerHierarchy = null; // Stores the full tree structure
      let currentDashboardSelection = { 
        emails: [], // The list of emails to query (flattened)
        name: "None", // Name to display on the button/title
        isFullHierarchy: false // Whether this selection includes nested reports
      };
      
      // --- NEW/MODIFIED: Dark Mode Functions (Removed direct icon manipulation) ---
      const DARK_MODE_KEY = 'kap_dark_mode';
      
      // New core function called by the checkbox event listener
      function toggleThemeState() {
          // Read the current state of the checkbox
          const toggleInput = document.getElementById('dark-mode-toggle');
          // Checkbox is already toggled when this event fires
          const newThemeIsDark = toggleInput.checked; 
          
          applyTheme(newThemeIsDark);
          localStorage.setItem(DARK_MODE_KEY, newThemeIsDark ? 'enabled' : 'disabled');
      }

      function applyTheme(isDark) {
        const body = document.body;
        const toggleInput = document.getElementById('dark-mode-toggle');
        
        if (isDark) {
          body.classList.add('dark-mode');
          body.setAttribute('data-theme', 'dark');
          if (toggleInput) toggleInput.checked = true; // Set checkbox state
          
          // Invert the refresh icon
          document.querySelectorAll('#header-refresh-button img, #header-role-request-button img').forEach(img => {
               img.style.filter = 'invert(100%)';
          });
          
        } else {
          body.classList.remove('dark-mode');
          body.setAttribute('data-theme', 'light');
          if (toggleInput) toggleInput.checked = false; // Set checkbox state

          // Reset the refresh icon filter
          document.querySelectorAll('#header-refresh-button img, #header-role-request-button img').forEach(img => {
               img.style.filter = 'none';
          });
        }
        
        // Re-draw charts when theme changes to apply new colors
        // Note: The original code expected Google Charts, but since they were removed
        // we keep the redraw logic here for completeness, though it's mainly for aesthetics now.
        if (window.lastDashboardData) {
            drawDashboard(window.lastDashboardData);
        }
      }

      function initializeTheme() {
        const savedTheme = localStorage.getItem(DARK_MODE_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        let initialTheme = prefersDark;

        if (savedTheme === 'enabled') {
            initialTheme = true;
        } else if (savedTheme === 'disabled') {
            initialTheme = false;
        }
        
        // Use a slight delay to ensure the DOM element for the toggle is ready
        setTimeout(() => {
            applyTheme(initialTheme);
            
            const toggleInput = document.getElementById('dark-mode-toggle');
            if (toggleInput) {
                // Attach listener only after the DOM is fully loaded and theme is set
                toggleInput.addEventListener('change', toggleThemeState);
            }
        }, 0); 
      }
      
      // --- Status Message Utility ---
      function setStatus(id, type, message) {
        const statusDiv = document.getElementById(id);
        
        // Hide all statuses first (removes visible class)
        document.querySelectorAll('.status-message').forEach(div => {
            div.classList.remove('visible', 'success', 'error', 'processing');
        });
        
        if (message) {
            statusDiv.classList.add('visible', type);
            statusDiv.innerText = message;
        } else {
            statusDiv.classList.remove('visible', 'success', 'error', 'processing');
        }
      }
      // *** NEW HELPER FUNCTION to add in <script> tag ***
      function setAllPunchButtonsDisabled(disabled) {
        document.querySelectorAll('#buttons button, #other-buttons button').forEach(btn => {
          btn.disabled = disabled;
        });
      }
      // === TAB SWITCHING FUNCTION ===
      function showTab(tabName) {
        // Hide all panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.style.display = 'none';
        });

        // Deactivate all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
          button.classList.remove('active');
        });
        
        // Clear all status messages
        document.querySelectorAll('.status-message').forEach(div => {
            div.classList.remove('visible', 'success', 'error', 'processing');
        });

        // Show the correct panel and activate the correct button
        document.getElementById(tabName + '-panel').style.display = 'block';
        document.getElementById(tabName + '-tab-button').classList.add('active');
        
        // Refresh data when certain tabs are clicked
        if (tabName === 'leave-approval') {
         loadLeaveReport();
         } else if (tabName === 'leave-request') {
          loadMyRequests();
          google.script.run.withSuccessHandler(user => {
            if(user && user.myBalances) populateMyBalances(user.myBalances);
          }).getUserInfo();
        } else if (tabName === 'my-schedule') {
          loadMySchedule();
        } else if (tabName === 'dashboard') {
           loadManagerHierarchy();
           if (window.lastDashboardData) {
               // Re-draw on tab switch to apply theme/resize changes
               drawDashboard(window.lastDashboardData);
           }
        } else if (tabName === 'coaching') {
          loadMyCoaching();
        
        // *** ADD THIS ELSE IF BLOCK ***
        } else if (tabName === 'registration-admin') {
          loadRegistrationAdmin();
        
        // *** ADD THIS ELSE IF BLOCK ***
        } else if (tabName === 'reporting-line') {
          loadPendingMovements();
          // Clear history list when tab is clicked
          document.getElementById('movement-history-list').innerHTML = '<p class="text-color-secondary">Select a user to view their movement history.</p>';
        // *** ADD THIS ELSE IF BLOCK ***
        } else if (tabName === 'announcements-admin') {
          loadAnnouncements_Admin();
  }
        
      }
      
      // --- Refresh User Info ---
      function refreshCurrentData() {
        const btn = document.getElementById('header-refresh-button');
        btn.classList.add('loading');
        
        const activeTab = document.querySelector('.tab-button.active');
        const activeTabName = activeTab ? activeTab.id.replace('-tab-button', '') : 'punch';
        
        google.script.run
          .withSuccessHandler(user => {
            populateUserInfo(user); 
            
            // Now, reload the data for the specific tab
            if (activeTabName === 'leave-approval') {
              const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
              loadPendingRequests(currentFilter);
            } else if (activeTabName === 'leave-request') {
              loadMyRequests();
            } else if (activeTabName === 'my-schedule') {
              loadMySchedule();
            } else if (activeTabName === 'dashboard') {
              loadManagerHierarchy();
              loadDashboard();
            } else if (activeTabName === 'history-report' && lastHistoryData) {
              loadHistoryReport(); 
            } else if (activeTabName === 'coaching') {
              loadMyCoaching(); // <-- Use the new function name
            }
            
            setTimeout(() => {
              btn.classList.remove('loading');
            }, 500); 
          })
          .withFailureHandler(err => {
            btn.classList.remove('loading');
            const infoDiv = document.getElementById('agent-info');
            infoDiv.innerHTML = "Error refreshing data. Please try again.";
            infoDiv.classList.add('error');
          })
          .getUserInfo();
      }

      // NEW: Extracted user info population into its own function
      function populateUserInfo(user) {
        const infoDiv = document.getElementById('agent-info');
        
        if (!user || !user.name) { // Simplified check
          infoDiv.innerHTML = "Your email is not registered. Contact your supervisor.";
          infoDiv.className = 'error'; 
          return;
        }

        selfUserName = user.name; 
        selfRole = user.role; 
        allUsersList = user.allUsers; 
        allAdminsList = user.allAdmins; 
        
        // --- Apply Role-Based Body Class ---
        document.body.setAttribute('data-role', user.role);

        let displayRole = user.role.charAt(0).toUpperCase() + user.role.slice(1);
        
        // *** NEW: Show Account Status if Pending ***
        if (user.accountStatus === 'Pending') {
          infoDiv.innerHTML = `<strong>User:</strong> ${user.name} | <strong>Email:</strong> ${user.email} | <strong>Account Status:</strong> <span style="color:#c53030; font-weight: 700;">Pending Approval</span>`;
          // *** HIDE ALL TABS ***
          document.getElementById('tab-nav').style.display = 'none';
          document.getElementById('punch-panel').innerHTML = `
            <h2 style="color: var(--konecta-blue);">Registration Pending</h2>
            <p class="text-color-secondary">Your account registration is pending final approval from an administrator. Please check back later.</p>
            <p class="text-color-secondary">If your request is denied, you will be prompted to re-select a supervisor when you log in again.</p>
          `;
          
          // Check if they are new and need to pick a supervisor
          if (user.isNewUser) {
            showSupervisorModal(allAdminsList);
          } else {
            // Not a new user, but pending. Check if they have a submission.
            loadMyRegistrationStatus();
          }
          // document.getElementById('app-loader').style.display = 'none'; // Loader is hidden in loadUserInfo
          return; // Stop here for pending users
        }

        // --- User is 'Active' ---
        infoDiv.innerHTML = `<strong>User:</strong> ${user.name || 'ADMIN'} &nbsp;|&nbsp; <strong>Email:</strong> ${user.email} &nbsp;|&nbsp; <strong>Role:</strong> ${displayRole}`; 
        infoDiv.className = '';
        
        document.getElementById('buttons').style.display = 'block';
        document.getElementById('other-buttons').style.display = 'block';
        document.getElementById('my-schedule-tab-button').style.display = 'inline-block';
        
        // *** REPLACE THE OLD 'header-role-request-button' LINE WITH THIS BLOCK ***
        const roleButton = document.getElementById('header-role-request-button');
        if (user.role === 'superadmin') {
          roleButton.style.display = 'flex';
          roleButton.setAttribute('onclick', 'showRoleApprovalModal()');
          roleButton.setAttribute('title', 'Manage Role Upgrade Requests');
          if (user.hasPendingRoleRequests) {
            roleButton.classList.add('has-notification');
          } else {
            roleButton.classList.remove('has-notification');
          }
        } else if (user.role === 'admin' || user.role === 'agent') {
          roleButton.style.display = 'flex';
          roleButton.setAttribute('onclick', 'showRoleRequestModal()');
          roleButton.setAttribute('title', 'Request Role Upgrade');
          roleButton.classList.remove('has-notification');
        }
        // *** END OF BLOCK ***
        
        if (user.myBalances) populateMyBalances(user.myBalances);
        if (user.currentStatus) updateCurrentStatus(user.currentStatus);

        // --- Show/Hide Tabs Based on Role ---
        if (user.role === 'admin' || user.role === 'superadmin') {
          document.getElementById('dashboard-tab-button').style.display = 'inline-block';
          document.getElementById('schedule-tab-button').style.display = 'inline-block';
          document.getElementById('leave-approval-tab-button').style.display = 'inline-block';
          document.getElementById('admin-tools-tab-button').style.display = 'inline-block'; 
          document.getElementById('history-report-tab-button').style.display = 'inline-block';
          document.getElementById('coaching-admin-tab-button').style.display = 'inline-block'; 
          
          document.getElementById('history-user-select-container').style.display = 'block'; 
          
          document.getElementById('reporting-line-tab-button').style.display = 'inline-block';
          
          populateAdminDropdown(allUsersList, selfUserName, 'agent-select', 'Punch for: Myself');
          document.getElementById('admin-panel').style.display = 'block';
          populateAdminDropdown(allUsersList, selfUserName, 'schedule-agent-select', 'Select a user');
          populateAdminDropdown(allUsersList, selfUserName, 'manual-punch-user', 'Select a user'); 
          populateAdminDropdown(allUsersList, selfUserName, 'admin-leave-user', 'Select user to submit for'); 
          
          populateAdminDropdown(allUsersList, selfUserName, 'balance-user-select', 'Select a user');
          
          if (document.getElementById('dashboard-panel').style.display === 'block') {
             loadManagerHierarchy();
          }

          populateAdminCustomSelect(allUsersList, selfUserName, 'history');
          
          populateAdminDropdown(allUsersList, selfUserName, 'reporting-line-user', 'Select a user');
          populateSupervisorDropdown(allAdminsList, 'reporting-line-supervisor');
          populateAdminDropdown(allUsersList, selfUserName, 'movement-history-user', 'Select your subordinate...');
          
          populateAdminDropdown(allUsersList, selfUserName, 'coaching-agent-select', 'Select an agent');
          
          document.getElementById('coaching-form-container').style.display = 'block';
          document.getElementById('coaching-list-container').querySelector('h2').innerText = 'Subordinate Coaching History';
          populateAdminDropdown(allUsersList, selfUserName, 'leave-report-user', 'Select a user...');
          const lrUserSelect = document.getElementById('leave-report-user');
          if (lrUserSelect) {
            const allOption = document.createElement('option');
            allOption.value = 'ALL_SUBORDINATES';
            allOption.textContent = 'All My Subordinates';
            lrUserSelect.prepend(allOption);
            
            if (selfRole === 'superadmin') {
               const allUsersOption = document.createElement('option');
               allUsersOption.value = 'ALL_USERS';
               allUsersOption.textContent = 'All Users (Superadmin)';
               lrUserSelect.prepend(allUsersOption);
            }
            lrUserSelect.value = 'ALL_SUBORDINATES'; // Default
          }

          if (user.role === 'admin' || user.role === 'superadmin') {
             // *** MODIFIED: Show Registration Admin tab for admin and superadmin ***
             document.getElementById('registration-admin-tab-button').style.display = 'inline-block';
          }
          document.getElementById('my-schedule-title').innerText = "My Team's Upcoming Schedule";

          if (user.role === 'superadmin') {
            document.getElementById('balance-adjustment-section').style.display = 'block'; // *** NEW ***
             // *** MOVED: Announcements tab is still superadmin only ***
             document.getElementById('announcements-admin-tab-button').style.display = 'inline-block';
          }
          
        } else {
          // User is an agent
          document.getElementById('history-report-tab-button').style.display = 'inline-block'; 
          
          document.getElementById('history-user-select-container').style.display = 'none';

          document.getElementById('coaching-form-container').style.display = 'none';
          document.getElementById('coaching-list-container').querySelector('h2').innerText = 'My Coaching History';
          
        }
        
        // Show coaching tab for everyone
        document.getElementById('coaching-tab-button').style.display = 'inline-block'; 
        loadMyRequests();
      }

      function loadUserInfo() { 
        // 1. Check saved theme
        initializeTheme();
        
        // 2. Set timeout for failure
        const loadTimeout = setTimeout(() => {
          
          const infoDiv = document.getElementById('agent-info');
          infoDiv.innerHTML = "The request timed out. Please refresh and re-authorize the script if asked.";
          infoDiv.classList.add('error', 'visible');
          infoDiv.style.textAlign = 'center';
          document.getElementById('app-loader').style.display = 'none';
        }, 15000);

        // 3. Run script
        google.script.run
          .withSuccessHandler(user => { 
            clearTimeout(loadTimeout); 
            populateUserInfo(user);
            loadAnnouncements(); // Load banner for all users on page load
            document.getElementById('app-loader').style.display = 'none';
          })
          .withFailureHandler(err => {
            clearTimeout(loadTimeout); 
            const infoDiv = document.getElementById('agent-info');
            let errorMsg = err.message || JSON.stringify(err);
            infoDiv.innerHTML = "Could not load user info. Error: " + errorMsg; 
            infoDiv.classList.add('error', 'visible');
            document.getElementById('app-loader').style.display = 'none';
        }).getUserInfo(); 
      }
      
      // NEW: Function to handle populating custom multi-selects (History)
      function populateAdminCustomSelect(users, selfName, type) { 
          // Only used for history now
          if (type !== 'history') return;
          
          const selectedState = selectedHistoryUsers;
          const dropdownDiv = document.getElementById(`custom-${type}-select-dropdown`);
          
          if (!dropdownDiv) return;

          // Set the global user list state for lookups
          historyUserList = users;
          
          // Reset DOM
          dropdownDiv.innerHTML = ''; 
          
          // Add the "Select All" option
          let allOption = document.createElement('div');
          allOption.className = 'dropdown-item';
          allOption.innerHTML = `<input type="checkbox" id="select-all-checkbox-${type}" onclick="toggleSelectAll('${type}')"> <label for="select-all-checkbox-${type}" style="flex: 1; cursor: pointer;">Select All</label>`;
          allOption.onclick = (e) => e.stopPropagation(); 
          dropdownDiv.appendChild(allOption);
          
          // Add individual user options
          users.forEach(user => { 
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.setAttribute('data-email', user.email);
            item.innerHTML = `
              <input type="checkbox" id="user-checkbox-${type}-${user.email}" data-email="${user.email}">
              <label for="user-checkbox-${type}-${user.email}" style="flex: 1; cursor: pointer;">${user.name} (${user.email})</label>
            `;
            // Pass the item and email to the selection handler
            item.onclick = (e) => selectUserItem(type, e, item, user.email, user.name);
            dropdownDiv.appendChild(item);
          });
          
          // Ensure button display reflects initial (empty) state
          updateSelectButtonDisplay(type);
      }
      
      // MODIFIED: Original function now skips custom select IDs
      function populateAdminDropdown(users, selfName, dropdownId, selfText) { 
        // Skip custom selects handled by populateAdminCustomSelect
        if (dropdownId.includes('history-user-select')) {
             return;
        }

        const select = document.getElementById(dropdownId);
        select.innerHTML = ''; 
        
        // Create the 'Me' or 'Select a user' option
        const firstOption = document.createElement('option');
        if (dropdownId === 'agent-select') {
          const selfUser = users.find(u => u.name === selfName);
          firstOption.value = selfUser ? selfUser.email : '';
          firstOption.textContent = `${selfText} (${selfName})`;
        } else {
          firstOption.value = ""; 
          firstOption.textContent = selfText;
        }
        select.appendChild(firstOption);

        // Add all other users
        users.forEach(user => { 
          // NEW: For coaching dropdown, only show non-admin users
          if (dropdownId === 'coaching-agent-select' && (user.role === 'admin' || user.role === 'superadmin')) {
             return;
          }
        
          const option = document.createElement('option');
          option.value = user.email; // Use EMAIL as value
          option.textContent = `${user.name} (${user.email})`;
          select.appendChild(option);
        });
        
        // Select the 'Me' option for the punch clock default
        if (dropdownId === 'agent-select') {
          select.selectedIndex = 0;
        }
      }
      
      function populateSupervisorDropdown(admins, dropdownId = 'leave-supervisor') {
        const select = document.getElementById(dropdownId);
        select.innerHTML = '<option value="">-- Select a supervisor --</option>'; 
        
        admins.forEach(admin => {
          const option = document.createElement('option');
          option.value = admin.email; 
          option.textContent = `${admin.name}`; 
          select.appendChild(option);
        });
      }
      
      function populateMyBalances(balances) {
        if (!balances) return;
        document.getElementById('balance-annual').textContent = balances.annual;
        document.getElementById('balance-sick').textContent = balances.sick;
        document.getElementById('balance-casual').textContent = balances.casual;
      }

      function punch(action) {
        const adminSelect = document.getElementById('agent-select');
        let targetUserName = '';
        
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          const selectedEmail = adminSelect.value;
          const user = allUsersList.find(u => u.email === selectedEmail);
          targetUserName = user ? user.name : '';
        } else {
          targetUserName = selfUserName;
        }
        
        if (!targetUserName) { 
           setStatus('status', 'error', 'Please select a user to punch for.');
           return;
        }

        setStatus('status', 'processing', `Processing "${action}" for ${targetUserName}...`);

        google.script.run
          .withSuccessHandler(response => { // <-- 'msg' is now 'response'
            // 'response' is now an object { message: "...", newStatus: {...} }
            if (response.message.startsWith('Error:')) {
              setStatus('status', 'error', response.message.replace('Error: ', ''));
            } else {
              setStatus('status', 'success', response.message);
            }
            // --- ADD THIS LINE ---
            updateCurrentStatus(response.newStatus); 
            // --- END ADDITION ---
          })
          .withFailureHandler(err => {
            setStatus('status', 'error', 'Unexpected error: ' + (err.message || JSON.stringify(err)));
          })
          .webPunch(action, targetUserName, null);
      }
      
      // REPLACE this function in your <script> tag
function toggleTimeFields() {
  const leaveType = document.getElementById('schedule-leave-type').value;
  const timeFields = document.getElementById('time-fields');
  if (leaveType === 'Present') {
    timeFields.style.display = 'flex';
  } else {
    timeFields.style.display = 'none';
    // *** NEW: Clear the shift end date field when hiding ***
    document.getElementById('schedule-end-date-shift').value = '';
    document.getElementById('schedule-start-time').value = '';
    document.getElementById('schedule-end-time').value = '';
  }
}
      
     // REPLACE this function in your <script> tag
function submitSchedule() {
  try {
    const userEmail = document.getElementById('schedule-agent-select').value;
    const user = allUsersList.find(u => u.email === userEmail);
    if (!user) throw new Error("Please select a user."); 
    
    let startDate = document.getElementById('schedule-start-date').value;
    let endDateRange = document.getElementById('schedule-end-date').value; // This is the date *range*
    const leaveType = document.getElementById('schedule-leave-type').value;
    let startTime = document.getElementById('schedule-start-time').value;
    let endTime = document.getElementById('schedule-end-time').value;
    
    // *** NEW: Read the SHIFT end date ***
    let shiftEndDate = document.getElementById('schedule-end-date-shift').value;
    
    if (!startDate) throw new Error("Please select a Start Date.");
    if (!endDateRange) endDateRange = startDate; // Default range to single day
    if (new Date(endDateRange) < new Date(startDate)) throw new Error("End Date of range cannot be before Start Date.");
    
    if (leaveType === 'Present') {
      if (!startTime || !endTime) throw new Error("Shift Start and End Time are required for 'Present' status.");
      // If shiftEndDate is blank, it will be handled by the server
    } else {
      startTime = "";
      endTime = "";
      shiftEndDate = ""; // Clear shift end date if not present
    }
    
    setStatus('schedule-status', 'processing', `Submitting schedule for ${user.name}...`);

    google.script.run
      .withSuccessHandler(msg => {
        if (msg.startsWith('Error:')) {
          setStatus('schedule-status', 'error', msg.replace('Error: ', ''));
        } else {
          setStatus('schedule-status', 'success', msg);
          document.getElementById('schedule-form').reset();
          document.getElementById('schedule-start-date').valueAsDate = new Date();
          toggleTimeFields();
        }
      })
      .withFailureHandler(err => {
        setStatus('schedule-status', 'error', 'Unexpected error: ' + (err.message || JSON.stringify(err)));
      })
      // *** MODIFIED: Pass shiftEndDate to the new function signature ***
      .webSubmitScheduleRange(userEmail, user.name, startDate, endDateRange, startTime, endTime, leaveType, shiftEndDate); 

  } catch (err) {
    setStatus('schedule-status', 'error', err.message);
  }
}
      
      // --- Helper to format date strings ---
      function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString("en-US", { 
          year: 'numeric', month: '2-digit', day: '2-digit' 
        });
      }
      
      // --- Helper to format time strings ---
      function formatTime(dateStr) {
        if (!dateStr) return '--:--';
        // Check if dateStr is a full date string or just a time part
        if (dateStr.includes('T') || dateStr.includes('-')) {
             return new Date(dateStr).toLocaleTimeString("en-US", { 
              hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
            });
        }
        // If it's just a time string like "09:00:00", we can't reliably format it without assuming a date.
        return dateStr;
      }
      
      // --- Helper to format seconds ---
      function formatSeconds(seconds) {
        if (typeof seconds !== 'number' || isNaN(seconds)) return '0 sec';
        if (seconds === 0) return '0 sec';
        const isNegative = seconds < 0;
        seconds = Math.abs(seconds);
        
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        
        let str = isNegative ? '-' : '';
        if (h > 0) str += `${h}h `;
        if (m > 0) str += `${m}m `;
        if (s > 0 || (h === 0 && m === 0)) str += `${s}s`;
        
        return str.trim();
      }

      // --- NEW: Dynamic Status Timer ---
      let statusTimer = null;

/**
       * (REPLACE THIS FUNCTION in your <script> tag)
       * Updates the new #current-status-display with live elapsed time
       * AND manages the enabled/disabled state of punch buttons.
       * *** NOW INCLUDES EXCEED WARNINGS ***
       */
      function updateCurrentStatus(statusInfo) {
        if (statusTimer) {
          clearInterval(statusTimer); // Stop any existing timer
        }

        const displayDiv = document.getElementById('current-status-display');
        
        // --- Button State Logic ---
        setAllPunchButtonsDisabled(true); // Disable all by default

        if (!statusInfo || !statusInfo.status || statusInfo.status === 'Logged Out') {
          displayDiv.style.visibility = 'hidden';
          // 1. Logged Out State: Only Login is enabled
          document.querySelector('button[onclick="punch(\'Login\')"]').disabled = false;
          return; // Stop here
        }

        const punchTime = new Date(statusInfo.time);
        
        const updateText = () => {
          const now = new Date();
          const diffMs = now.getTime() - punchTime.getTime();
          const diffSec = Math.floor(diffMs / 1000);
          
          let elapsedStr = '';
          if (diffSec < 60) {
            elapsedStr = `${diffSec}s ago`;
          } else if (diffSec < 3600) {
            elapsedStr = `${Math.floor(diffSec / 60)}m ${diffSec % 60}s ago`;
          } else {
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            elapsedStr = `${h}h ${m}m ago`;
          }

          let statusClass = getStatusClass(statusInfo.status);
          if (statusInfo.status === 'Logged In') statusClass = 'Logged-In'; 

          displayDiv.className = `status-message visible status-${statusClass}`;
          displayDiv.style.visibility = 'visible';
          
          // --- NEW: Exceed Warning Logic ---
          let exceedWarning = "";
          let plannedSeconds = 0;
          
          if (statusInfo.status === 'On First Break' || statusInfo.status === 'On Last Break') {
            plannedSeconds = PLANNED_BREAK_SECONDS;
          } else if (statusInfo.status === 'On Lunch') {
            plannedSeconds = PLANNED_LUNCH_SECONDS;
          }
          
          if (plannedSeconds > 0 && diffSec > plannedSeconds) {
            const exceededSeconds = diffSec - plannedSeconds;
            const ex_m = Math.floor(exceededSeconds / 60);
            const ex_s = exceededSeconds % 60;
            // Use the CSS variable for "leave" text color (red)
            exceedWarning = ` <strong style="color: var(--status-leave-text);">(Exceeded by ${ex_m}m ${ex_s}s)</strong>`;
            
            // Make the whole status box flash red if exceeded
            displayDiv.className = `status-message visible status-leave`;
          }
          // --- END NEW ---

          displayDiv.innerHTML = `
            <strong>${statusInfo.status}</strong> 
            (since ${formatTime(statusInfo.time)} - ${elapsedStr})${exceedWarning}
          `;
        };

        updateText(); // Run once immediately
        statusTimer = setInterval(updateText, 1000); // Update every second

        // --- Button State Logic (continued) ---
        if (statusInfo.status === 'Logged In') {
          // 2. Logged In State: Enable everything *except* Login
          setAllPunchButtonsDisabled(false);
          document.querySelector('button[onclick="punch(\'Login\')"]').disabled = true;
        
        } else if (statusInfo.status.startsWith('On ')) {
          // 3. "On Break/Lunch/Coaching" State: Only enable the matching "Out" button
          setAllPunchButtonsDisabled(true); // All are disabled...
          
          const statusType = statusInfo.status.replace('On ', ''); // "First Break", "Lunch", "Coaching"
          
          // Find the matching "Out" button
          let matchingButton = null;
          if (statusType === 'First Break') {
            matchingButton = document.querySelector('button[onclick="punch(\'First Break Out\')"]');
          } else if (statusType === 'Lunch') {
            matchingButton = document.querySelector('button[onclick="punch(\'Lunch Out\')"]');
          } else if (statusType === 'Last Break') {
            matchingButton = document.querySelector('button[onclick="punch(\'Last Break Out\')"]');
          } else if (statusType === 'Coaching') {
            matchingButton = document.querySelector('button[onclick="punch(\'Coaching Out\')"]');
          } else if (statusType === 'Meeting') {
            matchingButton = document.querySelector('button[onclick="punch(\'Meeting Out\')"]');
          } else if (statusType === 'Personal') {
            matchingButton = document.querySelector('button[onclick="punch(\'Personal Out\')"]');
          }

          if (matchingButton) {
            matchingButton.disabled = false; // ...except the one that gets you out.
          }
        }
      }

      /**
       * Updates the new #current-status-display with live elapsed time.
       */
      function updateCurrentStatus(statusInfo) {
        if (statusTimer) {
          clearInterval(statusTimer); // Stop any existing timer
        }

        const displayDiv = document.getElementById('current-status-display');
        if (!statusInfo || !statusInfo.status || statusInfo.status === 'Logged Out') {
          displayDiv.style.visibility = 'hidden';
          return;
        }

        const punchTime = new Date(statusInfo.time);
        
        const updateText = () => {
          const now = new Date();
          const diffMs = now.getTime() - punchTime.getTime();
          const diffSec = Math.floor(diffMs / 1000);
          
          let elapsedStr = '';
          if (diffSec < 60) {
            elapsedStr = `${diffSec}s ago`;
          } else if (diffSec < 3600) {
            elapsedStr = `${Math.floor(diffSec / 60)}m ${diffSec % 60}s ago`;
          } else {
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            elapsedStr = `${h}h ${m}m ago`;
          }

          let statusClass = getStatusClass(statusInfo.status);
          // Use status-login style for "Logged In"
          if (statusInfo.status === 'Logged In') statusClass = 'Logged-In'; 

          displayDiv.className = `status-message visible status-${statusClass}`;
          displayDiv.style.visibility = 'visible';
          displayDiv.innerHTML = `
            <strong>${statusInfo.status}</strong> 
            (since ${formatTime(statusInfo.time)} - ${elapsedStr})
          `;
        };

        updateText(); // Run once immediately
        statusTimer = setInterval(updateText, 1000); // Update every second
      }
      
      // REPLACE this function in your <script> tag
function getStatusClass(status) {
    // Converts status string to CSS class format
    const formatted = status.replace(/[\s\/-]/g, '-');
    
    // *** ADD "Day-Off" to this list ***
    if (formatted === 'Not-Scheduled' || formatted === 'Day-Off') {
        return 'Pending-Login'; // Reuse yellow style
    }
    // Fallback for any leave types that weren't grouped
    if (['Sick', 'Annual', 'Casual'].includes(formatted)) {
        return 'On-Leave';
    }
    
    return formatted;
}

      function formatColoredSeconds(seconds, isPositive) {
          if (typeof seconds !== 'number' || isNaN(seconds) || seconds === 0) {
              return '0';
          }
          
          // Deviation (Tardy, Early, Exceed) is negative, Overtime is positive
          const actualSeconds = isPositive ? seconds : Math.abs(seconds);
          
          const h = Math.floor(actualSeconds / 3600);
          const m = Math.floor((actualSeconds % 3600) / 60);
          const s = Math.floor(actualSeconds % 60);
          
          let str = '';
          if (h > 0) str += `${h}h `;
          if (m > 0) str += `${m}m `;
          if (s > 0 || (h === 0 && m === 0)) str += `${s}s`;
          
          // Choose color: Red for deviation, Green for positive (Overtime)
          const color = isPositive ? '#34a853' : '#ea4335';
          
          return `<span style="font-weight: 600; color: ${color};">${str.trim()}</span>`;
      }


      function onMyRequestsFailure(error) {
        const listDiv = document.getElementById('my-requests-list');
        listDiv.innerHTML = `<p class="status-message error visible">Error loading requests: ${error.message || JSON.stringify(error)}</p>`;
      }

      function onPendingRequestsFailure(error) {
        // Set the status in the main 'approval-status' div, not in the list
        setStatus('approval-status', 'error', 'Error loading requests: ' + (error.message || JSON.stringify(error)));
      }

      // --- === `loadMyRequests` ---
      function loadMyRequests() {
        google.script.run
          .withSuccessHandler(populateMyRequests)
          .withFailureHandler(onMyRequestsFailure)
          .webGetMyRequests_V2();
      }
      
      // --- === `populateMyRequests` ---
      function populateMyRequests(requests) {
        console.log("Data for My Requests:", requests); // <-- ADD THIS LINE
        const listDiv = document.getElementById('my-requests-list');
        
        if (!Array.isArray(requests)) {
          listDiv.innerHTML = `<p class="status-message error visible">Received an invalid response from server.</p>`;
          return;
        }
        
        if (requests.length === 0) {
          listDiv.innerHTML = '<p class="text-color-secondary">You have no leave requests on file.</p>';
          return;
        }
        
        let html = '';
        requests.reverse().forEach((req, index) => {
          let statusClass = '';
          if (req.status === 'Pending') statusClass = 'status-pending';
          if (req.status === 'Approved') statusClass = 'status-approved';
          if (req.status === 'Denied') statusClass = 'status-denied';
          let actionHtml = '';
          if (req.status === 'Approved' || req.status === 'Denied') {
            actionHtml = `<p><strong>Action:</strong> ${req.status} by ${req.actionBy || 'N/A'} on ${formatDate(req.actionDate)}</p>`;
          }
          html += `
            <div class="request-list-item">
              <div class="item-details">
                <h4>${req.leaveType} Request (ID: ${req.requestID.slice(-5)})</h4>
                <p>
                  <strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)}
                  (${req.totalDays} ${req.totalDays > 1 ? 'days' : 'day'})
                </p>
                <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
                ${req.reason ? `<p><strong>Reason:</strong> ${req.reason}</p>` : ''}
                ${req.sickNoteUrl ? `<p><strong>Sick Note:</strong> <a href="${req.sickNoteUrl}" target="_blank" style="color:var(--konecta-blue); font-weight: 600;">View PDF</a></p>` : ''}
                <p class="supervisor-info text-color-secondary"><strong>Supervisor:</strong> ${req. supervisorName || 'N/A'}</p>

                ${actionHtml}
                ${req.actionByReason ? `<p><strong>Admin Reason:</strong> ${req.actionByReason}</p>` : ''}

              </div>
              <div class="item-actions">
                <span class="status-badge ${statusClass}">${req.status}</span>
              </div>
            </div>
          `;
        });
        listDiv.innerHTML = html;
      }
      
      // 🛑 ADD THIS NEW FUNCTION 🛑
      function toggleSickNoteField() {
        const leaveType = document.getElementById('leave-type').value;
        const sickNoteGroup = document.getElementById('sick-note-upload-group');
        const sickNoteInput = document.getElementById('sick-note-file');

        if (leaveType === 'Sick') {
          sickNoteGroup.style.display = 'block';
          sickNoteInput.required = true;
        } else {
          sickNoteGroup.style.display = 'none';
          sickNoteInput.required = false;
          sickNoteInput.value = null; // Clear the file if they change their mind
        }
      }
      
      // 🛑 REPLACE your old submitLeaveRequest with this one 🛑
      function submitLeaveRequest() {
        // 1. Get all form values
        const leaveType = document.getElementById('leave-type').value;
        const startDate = document.getElementById('leave-start-date').value;
        let endDate = document.getElementById('leave-end-date').value;
        const reason = document.getElementById('leave-reason').value;
        const fileInput = document.getElementById('sick-note-file');
        const file = fileInput.files[0];

        try {
          // 2. Perform validation
          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }

          const requestObject = {
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason,
            fileInfo: null // We'll add this next
          };

          // 3. Check if file is required
          if (leaveType === 'Sick') {
            if (!file) {
              throw new Error("A PDF sick note is mandatory for sick leave.");
            }
            if (file.type !== 'application/pdf') {
              throw new Error("Only .pdf files are allowed.");
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
              throw new Error("File is too large. Maximum size is 5MB.");
            }

            // --- File is valid, read it ---
            setStatus('leave-status', 'processing', 'Uploading PDF... This may take a moment.');
            const reader = new FileReader();

            // 4. This runs when the file is done reading
            reader.onload = function(e) {
              const fileData = e.target.result.split(',')[1]; // Get Base64 data
              
              requestObject.fileInfo = { 
                name: file.name, 
                type: file.type, 
                data: fileData 
              };
              
              // 5. Now call the server
              runSubmitLeaveRequest(requestObject);
            };
            
            reader.onerror = function(e) {
              throw new Error("Error reading the file.");
            };

            // 6. Start reading the file
            reader.readAsDataURL(file);

          } else {
            // --- No file needed, submit directly ---
            setStatus('leave-status', 'processing', 'Submitting request...');
            runSubmitLeaveRequest(requestObject);
          }
          
        } catch (err) {
          setStatus('leave-status', 'error', err.message);
        }
      }

      // 🛑 ADD THIS NEW HELPER FUNCTION 🛑
      // This function contains the google.script.run call
      function runSubmitLeaveRequest(requestObject) {
        google.script.run
          .withSuccessHandler(msg => {
            if (msg.startsWith('Error:')) { 
              setStatus('leave-status', 'error', msg.replace('Error: ', ''));
            } else {
              setStatus('leave-status', 'success', msg);
              document.getElementById('leave-form').reset();
              document.getElementById('leave-start-date').valueAsDate = new Date();
              toggleSickNoteField(); // This will hide and clear the file input
              
              loadMyRequests();
              google.script.run.withSuccessHandler(user => {
                populateMyBalances(user.myBalances);
              }).getUserInfo();
              // Refresh admin panel if open (this logic was in your original file)
              // if (selfRole === 'admin' || selfRole === 'superadmin') {
              //   const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
              //   loadPendingRequests(currentFilter);
              // }
            }
          })
          .withFailureHandler(err => {
            setStatus('leave-status', 'error', err.message);
          })
          .webSubmitLeaveRequest(requestObject, null);
      }
      // *** START NEW FUNCTION ***
      function submitAdminRequest() {
        // *** Get the button at the start ***
        const btn = document.getElementById('header-role-request-button');
        try {
          const requestedRole = document.getElementById('admin-request-role').value;
          const justification = document.getElementById('admin-request-justification').value;

          if (!justification || justification.trim() === "") {
            throw new Error("A justification is required to request a role upgrade.");
          }
          
          // *** Add loading class ***
          btn.classList.add('loading');
          setStatus('admin-request-status', 'processing', 'Submitting request...');

          google.script.run
            .withSuccessHandler(msg => {
              // *** Remove loading class ***
              btn.classList.remove('loading');
              if (msg.startsWith('Error:')) {
                setStatus('admin-request-status', 'error', msg.replace('Error: ', ''));
              } else {
                // ...
                setTimeout(hideRoleRequestModal, 2000); 
              }
            })
            .withFailureHandler(err => {
              // *** Remove loading class ***
              btn.classList.remove('loading');
              setStatus('admin-request-status', 'error', err.message);
            })
            .webRequestAdminAccess(justification, requestedRole);

        } catch (err) {
          // *** Remove loading class (if error happens before call) ***
          btn.classList.remove('loading');
          setStatus('admin-request-status', 'error', err.message);
        }
      }
      // *** END NEW FUNCTION ***
      
      function loadLeaveReport() {
          const userEmail = document.getElementById('leave-report-user').value;
          const status = document.getElementById('leave-report-status').value;
          
          const filter = {
            userEmail: userEmail, // e.g., 'email@example.com' or 'ALL_SUBORDINATES'
            status: status // e.g., 'Pending' or 'All'
          };
          
          setStatus('approval-status', 'processing', 'Loading leave requests...');
          
          google.script.run
            .withSuccessHandler(populateLeaveReport)
            .withFailureHandler(onPendingRequestsFailure) // Can reuse this handler
            .webGetAdminLeaveRequests(filter); // New server function
        }

        function populateLeaveReport(requests) {
          const listDiv = document.getElementById('pending-requests-list');
          
          if (requests.error) {
             // Use the main status div
             setStatus('approval-status', 'error', requests.error);
             listDiv.innerHTML = ''; // Clear the list
             return;
          }
          if (!Array.isArray(requests) || requests.length === 0) {
            // Use the main status div and clear the list
            setStatus('approval-status', 'success', 'No leave requests found for this filter.');
            listDiv.innerHTML = '';
            return;
          }
          
          let html = '';
          // Sort by request date, newest first
          requests.sort((a, b) => new Date(b.requestedDate) - new Date(a.requestedDate));

          requests.forEach(req => {
            let statusClass = '';
            if (req.status === 'Pending') statusClass = 'status-pending';
            if (req.status === 'Approved') statusClass = 'status-approved';
            if (req.status === 'Denied') statusClass = 'status-denied';

            let balanceInfo = '';
            if (req.requesterBalance) {
              const balanceKey = req.leaveType.toLowerCase();
              const daysLeft = req.requesterBalance[balanceKey];
              balanceInfo = `<p class="text-color-secondary"><strong>Balance:</strong> ${daysLeft} days</p>`;
            }
            
            let actionHtml = '';
            if (req.status === 'Pending') {
               actionHtml = `
                <button class="approve-btn" onclick="approveDenyRequest('${req.requestID}', 'Approved')">Approve</button>
                <button class="deny-btn" onclick="approveDenyRequest('${req.requestID}', 'Denied')">Deny</button>
               `;
            } else {
               actionHtml = `
                <p style="margin: 4px 0;"><strong>Action:</strong> ${req.status} by ${req.actionBy || 'N/A'}</p>
                ${req.actionByReason ? `<p style="margin: 4px 0;"><strong>Admin Reason:</strong> ${req.actionByReason}</p>` : ''}
               `;
            }

            html += `
              <div class="request-list-item">
                <div class="item-details">
                  <h4>${req.requestedByName} - ${req.leaveType}</h4>
                  <p><strong>Dates:</strong> ${formatDate(req.startDate)} to ${formatDate(req.endDate)} (${req.totalDays} days)</p>
                  <p><strong>Submitted:</strong> ${formatDate(req.requestedDate)}</p>
                  ${req.reason ? `<p><strong>User Reason:</strong> ${req.reason}</p>` : ''}
                  ${req.sickNoteUrl ? `<p><strong>Sick Note:</strong> <a href="${req.sickNoteUrl}" target="_blank" style="color:var(--konecta-blue); font-weight: 600;">View PDF</a></p>` : ''}
                  
                  <p class="text-color-secondary"><strong>Supervisor:</strong> ${req.supervisorName || 'N/A'}</p>
                  ${balanceInfo}
                </div>
                <div class.item-actions">
                  <span class="status-badge ${statusClass}">${req.status}</span>
                  ${actionHtml}
                </div>
              </div>
            `;
          });
          listDiv.innerHTML = html;

          // *** THIS IS THE FIX ***
          // Set a success message in the correct div after loading
          setStatus('approval-status', 'success', `Successfully loaded ${requests.length} request(s).`);
        }
      
      // --- Admin Approve/Deny Function ---
      function approveDenyRequest(requestID, newStatus) {
  const reason = prompt(`(Optional) Please provide a reason for ${newStatus.toLowerCase()} this request:`);
  // user clicked cancel
  if (reason === null) {
    return;
  }

  setStatus('approval-status', 'processing', `Processing request...`);

  google.script.run
    .withSuccessHandler(msg => {
      if (msg.startsWith('Error:')) { 
        setStatus('approval-status', 'error', msg.replace('Error: ', ''));
      } else {
        setStatus('approval-status', 'success', msg);
      }
      // This function name will be changed in the next step
      loadLeaveReport(); 
    })
    .withFailureHandler(err => {
      setStatus('approval-status', 'error', err.message);
    })
    .webApproveDenyRequest(requestID, newStatus, reason); // <-- Pass the reason
}
      
      // --- Load My Schedule ---
      function loadMySchedule() {
        setStatus('my-schedule-status', 'processing', 'Loading your schedule...');
        document.getElementById('my-schedule-display').innerHTML = '';

        google.script.run
          .withSuccessHandler(populateMySchedule)
          .withFailureHandler(err => {
            setStatus('my-schedule-status', 'error', err.message);
          })
          .webGetMySchedule();
      }

     // REPLACE this function in your <script> tag
function populateMySchedule(scheduleData) {
  const displayDiv = document.getElementById('my-schedule-display');
  
  if (scheduleData.error) {
    setStatus('my-schedule-status', 'error', scheduleData.error);
    return;
  }
  
  if (scheduleData.length === 0) {
    setStatus('my-schedule-status', 'success', 'No schedule found for the next 7 days.');
    return;
  }

  setStatus('my-schedule-status', 'success', '');

  let html = `
    <table class="schedule-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Date</th>
          <th>Day</th>
          <th>Status</th>
          <th>Shift Start</th>
          <th>Shift End</th>
        </tr>
      </thead>
      <tbody>
  `;

  const today = new Date();
  const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const todayStr = today.toLocaleDateString('en-US', { timeZone: timeZone });


  scheduleData.forEach(day => {
    const scheduleDate = new Date(day.date);
    const scheduleDateStr = scheduleDate.toLocaleDateString('en-US', { timeZone: timeZone });
    
    const dayStr = scheduleDate.toLocaleDateString('en-US', { weekday: 'long', timeZone: timeZone });
    const dateStr = formatDate(day.date);
    
    let trClass = '';
    if (scheduleDateStr === todayStr) {
      trClass = 'day-today';
    }

    let statusClass = '';
    // *** MODIFIED: Use new "Day Off" logic ***
    if (day.leaveType !== 'Present' && day.leaveType !== 'Day Off') {
      statusClass = 'status-leave'; // Red color for sick, absent, etc.
    } else if (day.leaveType === 'Day Off') {
      statusClass = 'status-break'; // Blue-ish color for Day Off
    }

    html += `
      <tr class="${trClass}">
        <td><strong>${day.userName}</strong></td>
        <td>${dateStr}</td>
        <td>${dayStr}</td>
        <td class="${statusClass}">${day.leaveType}</td>
        <td>${day.startTime || '--:--'}</td>
        <td>${day.endTime || '--:--'}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  displayDiv.innerHTML = html;
}
      
      // --- Load History Report ---
      function loadHistoryReport() {
        const startDate = document.getElementById('history-start-date').value;
        const endDate = document.getElementById('history-end-date').value;
        
        let targetUserNames = [];
        
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          // MODIFIED: Use the new custom select function
          const selectedEmails = getSelectedUsers('history'); 
          const count = Object.keys(selectedHistoryUsers).length;
          
          if (selectedEmails.length === 1 && selectedEmails[0] === 'ALL_USERS') {
            // If "ALL_USERS" is returned, default to all names from the list
            targetUserNames = allUsersList.map(u => u.name);
          } else if (count === 0 && selectedEmails[0] !== 'ALL_USERS') {
            setStatus('my-history-status', 'error', 'Please select at least one user to view.');
            return;
          } else {
            // Map selected emails to user names
            targetUserNames = selectedEmails.map(email => {
              const user = allUsersList.find(u => u.email === email);
              return user ? user.name : null;
            }).filter(name => name); // Filter out any nulls
          }
          
        } else {
          // Agent mode: always query for self
          targetUserNames.push(selfUserName);
        }
        
        if (!startDate || !endDate) {
          setStatus('my-history-status', 'error', 'Please select a Start and End date to view.');
          return;
        }
        if (new Date(endDate) < new Date(startDate)) {
          setStatus('my-history-status', 'error', 'End Date cannot be before Start Date.');
          return;
        }
        
        setStatus('my-history-status', 'processing', `Loading history for ${targetUserNames.length} user(s)...`);
        document.getElementById('history-report-display').innerHTML = '';
        lastHistoryData = null;
        document.getElementById('export-csv-btn').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(data => {
            if (data.error) {
              setStatus('my-history-status', 'error', data.error);
              return;
            }
            
            setStatus('my-history-status', 'success', `Displaying ${data.length} record(s).`);
            populateHistoryReport(data);
            lastHistoryData = data;
            document.getElementById('export-csv-btn').style.display = 'inline-block';
          })
          .withFailureHandler(err => {
            setStatus('my-history-status', 'error', err.message);
          })
          .webGetAdherenceRange(targetUserNames, startDate, endDate);
      }
      
      // REPLACE this function in your <script> tag
function populateHistoryReport(data) {
  const displayDiv = document.getElementById('history-report-display');
  
  if (!data || data.length === 0) {
    displayDiv.innerHTML = '<p class="text-color-secondary">No adherence records found for the selected criteria.</p>';
    return;
  }

  const formatExceed = (value, isPositive) => {
    if (!value || value === 'No' || value === 0) return '0';
    const seconds = parseInt(value, 10);
    if (seconds > 0) {
        const color = isPositive ? '#34a853' : '#ea4335';
        return `<span style="font-weight: 600; color: ${color};">${formatSeconds(seconds)}</span>`;
    }
    return '0';
  };

  let html = `
    <table class="report-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Date</th>
          <th>Status</th>
          <th>Login</th>
          <th>Logout</th>
          <th>Tardy</th>
          <th>Early Leave</th>
          <th>Overtime</th>
          <th>Break Exceed</th>
          <th>Lunch Exceed</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(row => {
    const totalBreakExceed = (parseInt(row.firstBreakExceed, 10) || 0) + (parseInt(row.lastBreakExceed, 10) || 0);
    
    // *** NEW: Style "Day Off" and "Absent" ***
    let statusClass = '';
    const leaveTypeLower = (row.leaveType || 'N/A').toLowerCase();
    if (leaveTypeLower === 'absent' || leaveTypeLower === 'sick' || leaveTypeLower === 'annual' || leaveTypeLower === 'casual') {
      statusClass = 'status-leave'; // Red
    } else if (leaveTypeLower === 'day off') {
      statusClass = 'status-break'; // Blue-ish
    }

    html += `
      <tr>
        <td>${row.userName}</td>
        <td>${formatDate(row.date)}</td>
        <td class="${statusClass}">${row.leaveType || 'N/A'}</td>
        <td>${formatTime(row.login)}</td>
        <td>${formatTime(row.logout)}</td>
        <td>${formatExceed(row.tardy, false)}</td>
        <td>${formatExceed(row.earlyLeave, false)}</td>
        <td>${formatExceed(row.overtime, true)}</td>
        <td>${formatExceed(totalBreakExceed, false)}</td>
        <td>${formatExceed(row.lunchExceed, false)}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  displayDiv.innerHTML = html;
}
      
      // --- Export to CSV ---
      function exportHistoryToCSV() {
        if (!lastHistoryData || lastHistoryData.length === 0) {
          // Using a simple notification here instead of alert().
          setStatus('my-history-status', 'error', "No data to export. Please 'View History' first.");
          return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "User,Date,Status,Login,Logout,Tardy (sec),Early Leave (sec),Overtime (sec),1st Break Exceed (sec),Lunch Exceed (sec),Last Break Exceed (sec)\r\n";
        
        lastHistoryData.forEach(data => {
          let row = [
            `"${data.userName}"`,
            `"${formatDate(data.date)}"`,
            `"${data.leaveType || 'N/A'}"`,
            `"${formatTime(data.login)}"`,
            `"${formatTime(data.logout)}"`,
            data.tardy || 0,
            data.earlyLeave || 0,
            data.overtime || 0,
            data.firstBreakExceed || 0,
            data.lunchExceed || 0,
            data.lastBreakExceed || 0
          ].join(",");
          csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `History_Report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      }
      
      // --- Submit Manual Punch ---
      function submitManualPunch() {
        try {
          const userEmail = document.getElementById('manual-punch-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");

          const action = document.getElementById('manual-punch-action').value;
          const date = document.getElementById('manual-punch-date').value;
          const time = document.getElementById('manual-punch-time').value;
          
          if (!action) throw new Error("Please select a punch action.");
          if (!date) throw new Error("Please select a date.");
          if (!time) throw new Error("Please select a time.");
          
          const timestamp = new Date(date + 'T' + time).toISOString();
          
          setStatus('manual-punch-status', 'processing', `Processing "${action}" for ${user.name}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('manual-punch-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('manual-punch-status', 'success', msg);
                document.getElementById('manual-punch-form').reset();
                document.getElementById('manual-punch-date').valueAsDate = new Date();
                document.getElementById('manual-punch-user').selectedIndex = 0;
                document.getElementById('manual-punch-action').selectedIndex = 0;
              }
            })
            .withFailureHandler(err => {
              setStatus('manual-punch-status', 'error', err.message);
            })
            .webPunch(action, user.name, timestamp); 
            
        } catch(err) {
          setStatus('manual-punch-status', 'error', err.message);
        }
      }
      
      // --- Submit Admin Leave Request ---
      function submitAdminLeaveRequest() {
        try {
          const userEmail = document.getElementById('admin-leave-user').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          const leaveType = document.getElementById('admin-leave-type').value;
          const startDate = document.getElementById('admin-leave-start-date').value;
          let endDate = document.getElementById('admin-leave-end-date').value;
          const reason = document.getElementById('admin-leave-reason').value;

          if (!startDate) throw new Error("Please select a Start Date.");
          if (!endDate) endDate = startDate; 
          
          if (new Date(endDate) < new Date(startDate)) {
            throw new Error("End Date cannot be before Start Date.");
          }
          
          const requestObject = {
            leaveType: leaveType,
            startDate: startDate,
            endDate: endDate,
            reason: reason
          };
          
          setStatus('admin-leave-status', 'processing', `Submitting request for ${user.name}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('admin-leave-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('admin-leave-status', 'success', msg);
                document.getElementById('admin-leave-form').reset();
                document.getElementById('admin-leave-start-date').valueAsDate = new Date();
                
                const currentFilter = document.getElementById('filter-mine').classList.contains('active') ? 'mine' : 'all';
                loadPendingRequests(currentFilter);
              }
            })
            .withFailureHandler(err => {
              setStatus('admin-leave-status', 'error', err.message);
            })
            .webSubmitLeaveRequest(requestObject, user.email);
          
        } catch (err) {
          setStatus('admin-leave-status', 'error', err.message);
        }
      }
      
      // --- Submit Balance Adjustment ---
      function submitBalanceAdjustment() {
        try {
          const userEmail = document.getElementById('balance-user-select').value;
          const user = allUsersList.find(u => u.email === userEmail);
          if (!user) throw new Error("Please select a user.");
          
          const leaveType = document.getElementById('balance-leave-type').value;
          const amount = parseFloat(document.getElementById('balance-amount').value);
          const reason = document.getElementById('balance-reason').value;

          if (isNaN(amount) || amount === 0) throw new Error("Please enter a valid, non-zero amount.");
          if (!reason) throw new Error("A reason is required for all adjustments.");

          setStatus('balance-adjust-status', 'processing', `Adjusting ${leaveType} balance for ${user.name}...`);

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('balance-adjust-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('balance-adjust-status', 'success', msg);
                document.getElementById('balance-adjustment-form').reset();
              }
            })
            .withFailureHandler(err => {
              setStatus('balance-adjust-status', 'error', err.message);
            })
            .webAdjustLeaveBalance(user.email, leaveType, amount, reason);

        } catch (err) {
          setStatus('balance-adjust-status', 'error', err.message);
        }
      }
      
      // --- Import Schedule CSV ---
      function importScheduleCSV() {
        const fileInput = document.getElementById('csv-file-input');
        const file = fileInput.files[0];

        if (!file) {
          setStatus('csv-import-status', 'error', 'Please select a CSV file to import.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const data = parseCSV(text);
          
          if (!data || data.length === 0) {
            setStatus('csv-import-status', 'error', 'File is empty or invalid. Could not parse any rows.');
            return;
          }

          const headers = data[0];
          
          // *** THIS IS THE FIX ***
          // Now checks for 'agent email' (using bracket notation for the space)
          // and 'StartDate'
          if (!headers.Name || !headers.StartDate || !headers['agent email']) {
            setStatus('csv-import-status', 'error', 'Invalid CSV format. Must include headers: Name, StartDate, and agent email.');
            return;
          }
          // *** END OF FIX ***

          setStatus('csv-import-status', 'processing', `Importing ${data.length} schedule records...`);

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('csv-import-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('csv-import-status', 'success', msg);
                fileInput.value = '';
              }
            })
            .withFailureHandler(err => {
              setStatus('csv-import-status', 'error', err.message);
            })
            .webImportScheduleCSV(data);
        };
        
        reader.onerror = function(e) {
          setStatus('csv-import-status', 'error', 'Error reading file: ' + e.message);
        };

        reader.readAsText(file);
      }

      // --- Simple CSV Parser ---
      function parseCSV(csvText) {
        const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) return [];

        const headers = lines[0].split(',').map(h => h.trim());
        const result = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          const obj = {};
          for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = values[j] || '';
          }
          result.push(obj);
        }
        return result;
      }

      // --- NEW: Function to download the CSV template ---
      function downloadScheduleTemplate() {
        // *** MODIFIED: Headers match the new 7-column format ***
        const headers = "Name,StartDate,ShiftStartTime,EndDate,ShiftEndTime,LeaveType,agent email";
        
        // *** MODIFIED: Examples match the new 7-column format ***
        const example1 = "John Doe,11/30/2025,09:00,11/30/2025,18:00,Present,john.doe@konecta.com";
        const example2 = "Jane Smith,11/30/2025,,,,Sick,jane.smith@konecta.com";
        const example3 = "Peter Jones,12/01/2025,22:00,12/02/2025,06:00,Present,peter.jones@konecta.com,,(Overnight shift example)";
        
        // Combine headers and examples, separated by new lines
        const csvContent = [headers, example1, example2, example3].join("\r\n");

        // Create a "blob" (a file in the browser's memory)
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        
        // Create a temporary link element
        const link = document.createElement("a");
        if (link.download !== undefined) { // Check for browser support
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", "schedule_template.csv");
          link.style.visibility = 'hidden';
          
          // Add link to the page, click it, and then remove it
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }
      // --- END OF NEW FUNCTION ---

      // --- Dashboard Functions ---
      
      // History Select Functions (Kept for History Report only)
      function getSelectedUsers(type) {
        if (type !== 'history') return [];
        const userEmails = Object.keys(selectedHistoryUsers);
        if (userEmails.length === 0) {
          return ['ALL_USERS'];
        }
        return userEmails;
      }
      
      function toggleUserDropdown(type, event) {
          event.stopPropagation();
          if (type !== 'history') return;
          const dropdown = document.getElementById(`custom-${type}-select-dropdown`);
          const button = document.getElementById(`custom-${type}-select-button`);
          const isVisible = dropdown.style.display === 'block';

          if (isVisible) {
              dropdown.style.display = 'none';
              button.classList.remove('active');
          } else {
              document.querySelectorAll('.custom-select-dropdown').forEach(d => d.style.display = 'none');
              document.querySelectorAll('.custom-select-button').forEach(b => b.classList.remove('active'));
              dropdown.style.display = 'block';
              button.classList.add('active');
              
              const allChecked = Object.keys(selectedHistoryUsers).length === historyUserList.length && historyUserList.length > 0;
              const selectAllCheckbox = document.getElementById(`select-all-checkbox-${type}`);
              if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
          }
      }

      function selectUserItem(type, event, itemElement, userEmail, userName) {
          event.stopPropagation();
          if (type !== 'history') return;
          const checkbox = itemElement.querySelector(`input[data-email="${userEmail}"]`);
          
          if (event.target !== checkbox && event.target.tagName !== 'LABEL') {
              checkbox.checked = !checkbox.checked;
          }
          
          const finalCheckedState = checkbox.checked;
          const selectedState = selectedHistoryUsers;
          
          if (finalCheckedState) {
              selectedState[userEmail] = userName;
              itemElement.classList.add('selected');
          } else {
              delete selectedState[userEmail];
              itemElement.classList.remove('selected');
          }
          
          const allChecked = Object.keys(selectedState).length === historyUserList.length && historyUserList.length > 0;
          const selectAllCheckbox = document.getElementById(`select-all-checkbox-${type}`);
          if (selectAllCheckbox) {
              selectAllCheckbox.checked = allChecked;
          }

          updateSelectButtonDisplay(type);
      }

      function toggleSelectAll(type) {
          if (type !== 'history') return;
          const selectAllChecked = document.getElementById(`select-all-checkbox-${type}`).checked;
          const dropdown = document.getElementById(`custom-${type}-select-dropdown`);
          
          Object.keys(selectedHistoryUsers).forEach(key => delete selectedHistoryUsers[key]);
          
          if (selectAllChecked) {
              allUsersList.forEach(user => {
                  selectedHistoryUsers[user.email] = user.name;
              });
              dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                  item.classList.add('selected');
                  const checkbox = item.querySelector('input[type="checkbox"]');
                  if (checkbox && checkbox.id !== `select-all-checkbox-${type}`) checkbox.checked = true; 
              });
          } else {
              dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                  item.classList.remove('selected');
                  const checkbox = item.querySelector('input[type="checkbox"]');
                   if (checkbox && checkbox.id !== `select-all-checkbox-${type}`) checkbox.checked = false;
              });
          }
          updateSelectButtonDisplay(type);
      }

      function updateSelectButtonDisplay(type) {
          if (type !== 'history') return;
          const button = document.getElementById(`custom-${type}-select-button`);
          if (!button) return;
          
          const count = Object.keys(selectedHistoryUsers).length;
          
          if (count === 0) {
              button.textContent = 'Select Users (0 selected)';
          } else if (count === historyUserList.length && historyUserList.length > 0) {
              button.textContent = `All Users Selected (${count})`;
          } else {
              button.textContent = `Selected: ${count} user(s)`;
          }
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
          // --- History Logic ---
          const historyDropdown = document.getElementById('custom-history-select-dropdown');
          const historyButton = document.getElementById('custom-history-select-button');
          if (historyDropdown && historyButton && historyDropdown.style.display === 'block') {
              const container = document.getElementById('history-user-select-container');
              if (container && !container.contains(event.target)) {
                  historyDropdown.style.display = 'none';
                  historyButton.classList.remove('active');
              }
          }
      });


      // --- NEW HIERARCHY FUNCTIONS ---
      
      // Recursive function to flatten hierarchy into a list of emails
      function flattenHierarchy(node, list = []) {
          if (!node || !node.email) return list;
          list.push(node.email);
          node.subordinates.forEach(sub => flattenHierarchy(sub, list));
          return list;
      }
      
      // Function to get the current user's full hierarchy
      function loadMyFullHierarchy() {
          const managerEmail = allUsersList.find(u => u.name === selfUserName)?.email;
          if (!managerEmail) {
              setStatus('dashboard-status', 'error', "Could not find your user email.");
              return;
          }
          
          setStatus('dashboard-status', 'processing', 'Loading full subordinate team list...');

          // This fetches the flattened list of all direct and indirect reports
          google.script.run
            .withSuccessHandler(emails => {
                if (emails.error) {
                    setStatus('dashboard-status', 'error', emails.error);
                    return;
                }
                
                const managerName = allUsersList.find(u => u.email === managerEmail)?.name || 'Manager';
                
                currentDashboardSelection = {
                    emails: emails,
                    name: `${managerName}'s Full Hierarchy`,
                    isFullHierarchy: true
                };
                
                // Also update the selection display to reflect the full team
                document.getElementById('selected-user-display').textContent = currentDashboardSelection.name;
                
                // Deselect any node in the tree
                document.querySelectorAll('#hierarchy-tree-view .tree-node').forEach(node => {
                    node.classList.remove('selected');
                });
                
                setStatus('dashboard-status', 'success', `Set dashboard selection to: ${currentDashboardSelection.name}`);
                loadDashboard();
            })
            .withFailureHandler(err => {
                setStatus('dashboard-status', 'error', `Failed to load full hierarchy: ${err.message}`);
            })
            .webGetAllSubordinateEmails(managerEmail);
      }
      
      // Function to load the hierarchy tree from the server
      function loadManagerHierarchy() {
          const treeView = document.getElementById('hierarchy-tree-view');
          if (selfRole === 'agent') {
              treeView.innerHTML = `<p class="text-color-secondary">Hierarchy view available only to managers.</p>`;
              return;
          }
          treeView.innerHTML = `<p class="text-color-secondary">Fetching team hierarchy...</p>`;

          google.script.run
              .withSuccessHandler(hierarchyData => {
                  if (hierarchyData.error) {
                      treeView.innerHTML = `<p class="status-message error visible">${hierarchyData.error}</p>`;
                      return;
                  }
                  managerHierarchy = hierarchyData;
                  // Clear the tree before rendering
                  treeView.innerHTML = '';
                  renderHierarchyTree(hierarchyData, treeView);
                  
                  // Default selection: The manager's own node, loaded as a single user.
                  currentDashboardSelection.emails = [hierarchyData.email];
                  currentDashboardSelection.name = hierarchyData.name;
                  currentDashboardSelection.isFullHierarchy = false;
                  
                  document.getElementById('selected-user-display').textContent = hierarchyData.name;
                  
                  // Auto-select the root node (the manager)
                  const rootNode = document.querySelector(`#hierarchy-tree-view [data-email="${hierarchyData.email}"]`);
                  if (rootNode) {
                       rootNode.classList.add('selected');
                  }
                  
              })
              .withFailureHandler(err => {
                  treeView.innerHTML = `<p class="status-message error visible">Error loading hierarchy: ${err.message}</p>`;
              })
              .webGetManagerHierarchy();
      }
      
      // Recursive function to render the hierarchy
      function renderHierarchyTree(node, containerElement) {
          if (!node || !node.name) return;

          const isManager = node.role !== 'agent';
          const hasChildren = node.subordinates && node.subordinates.length > 0;
          const isRoot = node.depth === 0;
          
          // Get the role circle class
          const roleClass = node.role || 'agent';

          // 1. Create the container element for this node
          const nodeContainer = document.createElement('div');
          
          // 2. Create the clickable tree node element
          const nodeDiv = document.createElement('div');
          nodeDiv.className = `tree-node ${isManager ? 'collapsed' : ''}`;
          nodeDiv.setAttribute('data-email', node.email);
          nodeDiv.setAttribute('data-role', node.role);
          nodeDiv.setAttribute('data-has-children', hasChildren);
          nodeDiv.onclick = (e) => handleNodeClick(e, node);

          // Build the content of the node
          nodeDiv.innerHTML = `
              <img src="https://icons.veryicon.com/png/o/miscellaneous/cloud-services/arrow-right-13.png" class="toggle-icon" alt="Toggle">
              <span class="tree-label">
                  <div class="role-icon ${roleClass}"></div>
                  ${node.name}
                  ${isManager && !isRoot ? ` <span class="text-color-secondary">(${node.subordinates.length} reports)</span>` : ''}
              </span>
          `;
          
          nodeContainer.appendChild(nodeDiv);

          // 3. Create the subordinates list container
          if (hasChildren) {
              const subList = document.createElement('div');
              subList.className = 'subordinates-list';
              subList.id = `subordinates-${node.email.replace(/[.@]/g, '-')}`;

              // Recursively render children
              node.subordinates.forEach(sub => {
                  renderHierarchyTree(sub, subList);
              });
              
              nodeContainer.appendChild(subList);
          }
          
          containerElement.appendChild(nodeContainer);
      }
      
      // Handles click on any node in the tree
      function handleNodeClick(e, node) {
          e.stopPropagation();
          const nodeDiv = e.currentTarget;
          const isManager = node.role !== 'agent';
          const hasChildren = nodeDiv.getAttribute('data-has-children') === 'true';
          
          // 1. Handle Selection (always select the clicked user)
          document.querySelectorAll('#hierarchy-tree-view .tree-node').forEach(n => {
              n.classList.remove('selected');
          });
          nodeDiv.classList.add('selected');
          
          // Set selection state
          currentDashboardSelection.emails = [node.email]; // Default to single user
          currentDashboardSelection.name = node.name;
          currentDashboardSelection.isFullHierarchy = isManager && hasChildren;
          
          document.getElementById('selected-user-display').textContent = node.name;
          
          // 2. Handle Collapse/Expand for managers
          if (isManager && hasChildren) {
              const subList = document.getElementById(`subordinates-${node.email.replace(/[.@]/g, '-')}`);
              if (subList) {
                  const isCollapsed = nodeDiv.classList.contains('collapsed');
                  nodeDiv.classList.toggle('collapsed');
                  subList.style.display = isCollapsed ? 'block' : 'none';
              }
          }
      }
      
      // Reworked loadDashboard to use the new selection state
      function loadDashboard() {
        // Since Google Charts are not used for these visuals, we can remove the chartsLoaded check
        
        const date = document.getElementById('dashboard-date').value;
        if (!date) {
           setStatus('dashboard-status', 'error', 'Please select a date for the dashboard.');
           return;
        }
        
        // Final user list to send to the backend
        let userEmailsToQuery = [];
        let dashboardTitle = `Dashboard for ${formatDate(date)}`;
        
        if (currentDashboardSelection.isFullHierarchy) {
            // Load Full Hierarchy was explicitly requested or a manager node was clicked
            
            // If the manager node was clicked (isFullHierarchy is true, but emails has only 1), 
            // we must fetch the full list of reports for that single manager.
            if (currentDashboardSelection.emails.length === 1 && currentDashboardSelection.name !== "None") {
                 setStatus('dashboard-status', 'processing', `Loading full subordinate team for ${currentDashboardSelection.name}...`);
                 
                 // Synchronous call (Apps Script handles the full list generation)
                 google.script.run
                    .withSuccessHandler(emails => {
                         // Update the selection state with the flattened list
                        currentDashboardSelection.emails = emails;
                        
                        dashboardTitle = `Hierarchy for ${currentDashboardSelection.name} (${emails.length} users)`;
                        document.getElementById('dashboard-title').innerText = dashboardTitle;
                        
                        // Proceed to fetch dashboard data with the new list
                        fetchDashboardData(emails, date, dashboardTitle);
                    })
                    .withFailureHandler(err => {
                        setStatus('dashboard-status', 'error', `Failed to load hierarchy list: ${err.message}`);
                    })
                    .webGetAllSubordinateEmails(currentDashboardSelection.emails[0]);
                return;
            } else {
                 // Full hierarchy list was already loaded via 'Load My Full Hierarchy' button
                 userEmailsToQuery = currentDashboardSelection.emails;
                 dashboardTitle = currentDashboardSelection.name;
            }

        } else {
            // Single User or Saved Selection was used
            userEmailsToQuery = currentDashboardSelection.emails;
            dashboardTitle = `Dashboard for ${currentDashboardSelection.name} (${userEmailsToQuery.length} users)`;
        }
        
        if (userEmailsToQuery.length === 0) {
             setStatus('dashboard-status', 'error', 'Please select a user or load a team from the hierarchy.');
             return;
        }
        
        document.getElementById('dashboard-title').innerText = dashboardTitle;
        fetchDashboardData(userEmailsToQuery, date, dashboardTitle);
      }
      
      function fetchDashboardData(userEmails, date, dashboardTitle) {
          setStatus('dashboard-status', 'processing', `Loading data for ${userEmails.length} user(s) on ${formatDate(date)}...`);
          
          // Clear old data placeholders immediately to show processing
          document.getElementById('status-agent-list').innerHTML = '<p class="text-color-secondary">Loading...</p>';
          document.getElementById('adherence-detail-table').innerHTML = '<p class="text-color-secondary">Loading...</p>';
          document.getElementById('pending-leave-table').innerHTML = '<p class="text-color-secondary">Loading...</p>';


          google.script.run
            .withSuccessHandler(data => {
                window.lastDashboardData = data; 
                drawDashboard(data);
            })
            .withFailureHandler(err => {
              setStatus('dashboard-status', 'error', 'Server Error: ' + err.message);
              document.getElementById('status-agent-list').innerHTML = '<p class="text-color-secondary">Error loading data.</p>'; 
              document.getElementById('adherence-detail-table').innerHTML = '<p class="text-color-secondary">Error loading data.</p>';
              document.getElementById('pending-leave-table').innerHTML = '<p class="text-color-secondary">Error loading data.</p>';
            })
            .webGetDashboardData(userEmails, date);
      }
      
      // Function to save the current selection (single user or team list)
      function saveCurrentSelection() {
          if (currentDashboardSelection.emails.length === 0) {
              setStatus('dashboard-status', 'error', 'No user(s) currently selected to save.');
              return;
          }
          
          setStatus('dashboard-status', 'processing', 'Saving current selection as "My Team"...');
          
          google.script.run
            .withSuccessHandler(msg => {
              setStatus('dashboard-status', 'success', msg);
            })
            .withFailureHandler(err => {
              setStatus('dashboard-status', 'error', err.message);
            })
            .webSaveMyTeam(currentDashboardSelection.emails);
      }
      
      // Function to get the current list of emails from the selection state
      function getDashboardEmailsForSave() {
          // This function is now deprecated in favor of using the global state in saveCurrentSelection
          return currentDashboardSelection.emails;
      }
      
      function drawDashboard(data) {
        // Explicitly check for data existence and validity for each section
        if (!data || data.error) {
          setStatus('dashboard-status', 'error', data.error || 'Failed to load dashboard data.');
          document.getElementById('status-agent-list').innerHTML = '<p class="text-color-secondary">Error loading data.</p>'; 
          document.getElementById('pending-leave-table').innerHTML = '<p class="text-color-secondary">Error loading data.</p>';
          document.getElementById('adherence-detail-table').innerHTML = '<p class="text-color-secondary">Error loading data.</p>';
          return;
        }
        
        setStatus('dashboard-status', 'success', 'Dashboard loaded successfully.');
        
        // --- 1. Draw Status Agent List ---
        const statusAgentDiv = document.getElementById('status-agent-list');
        let statusHtml = '';
        
        if (!data.agentStatusList || data.agentStatusList.length === 0) {
             statusHtml = '<p class="text-color-secondary">No user status information available for this date/team.</p>';
        } else {
             data.agentStatusList.forEach(agent => {
                  const statusClass = getStatusClass(agent.status);
                  statusHtml += `
                      <div class="agent-status-item">
                          <strong>${agent.name}</strong>
                          <span class="status-tag status-${statusClass}">${agent.status}</span>
                      </div>
                  `;
             });
        }
        statusAgentDiv.innerHTML = statusHtml;


        // --- 2. Draw Adherence Detail List ---
        const adherenceDetailDiv = document.getElementById('adherence-detail-table');
        let adherenceHtml = '';
        
        if (!data.individualAdherenceMetrics || data.individualAdherenceMetrics.length === 0) {
            adherenceHtml = '<p class="text-color-secondary">No adherence data found for selected users today (No logins recorded).</p>';
        } else {
            // Filter users with zero deviation and sort by deviation (worst offenders first)
            const filteredMetrics = data.individualAdherenceMetrics.filter(user => {
                 const deviation = user.tardy + user.earlyLeave + user.breakExceed + user.lunchExceed;
                 return deviation > 0 || user.overtime > 0;
            });
            
            filteredMetrics.sort((a, b) => {
                 // Sort primarily by negative deviation (Tardy, Early, Breaks)
                 const aNegDeviation = a.tardy + a.earlyLeave + a.breakExceed + a.lunchExceed;
                 const bNegDeviation = b.tardy + b.earlyLeave + b.breakExceed + b.lunchExceed;
                 
                 if (bNegDeviation !== aNegDeviation) {
                    return bNegDeviation - aNegDeviation;
                 }
                 
                 // Secondary sort by Overtime
                 return b.overtime - a.overtime;
            });
            
            if (filteredMetrics.length === 0) {
                adherenceHtml = '<p class="text-color-secondary">All selected users have perfect adherence today. Great job!</p>';
            } else {
                filteredMetrics.forEach(user => {
                    const totalBreakExceed = (parseInt(user.breakExceed, 10) || 0) + (parseInt(user.lunchExceed, 10) || 0);
                    adherenceHtml += `
                        <div class="dashboard-detail-item">
                            <h4 class="detail-label" style="grid-column: 1 / -1; margin: 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); color: var(--konecta-blue);">${user.name}</h4>
                            
                            <span class="detail-label">Tardy:</span>
                            <span class="detail-value">${formatColoredSeconds(user.tardy, false)}</span>
                            
                            <span class="detail-label">Early Leave:</span>
                            <span class="detail-value">${formatColoredSeconds(user.earlyLeave, false)}</span>
                            
                            <span class="detail-label">Overtime:</span>
                            <span class="detail-value">${formatColoredSeconds(user.overtime, true)}</span>
                            
                            <span class="detail-label">Break Exceed:</span>
                            <span class="detail-value">${formatColoredSeconds(totalBreakExceed, false)}</span>
                            
                        </div>
                    `;
                });
            }
        }
        adherenceDetailDiv.innerHTML = adherenceHtml;


        // --- 3. Draw Pending Leave List ---
        const pendingLeaveDiv = document.getElementById('pending-leave-table');
        let pendingLeaveHtml = '';
        
        if (!data.pendingRequests || data.pendingRequests.length === 0) {
             pendingLeaveHtml = '<p class="text-color-secondary">No pending leave requests for selected users.</p>';
        } else {
            data.pendingRequests.forEach(req => {
                pendingLeaveHtml += `
                    <div class="dashboard-leave-item">
                        <div class="item-details">
                            <h4>${req.name} - ${req.type}</h4>
                            <p><strong>Dates:</strong> ${formatDate(req.startDate)} (${req.days} days)</p>
                        </div>
                         <span class="status-badge status-pending">Pending</span>
                    </div>
                `;
            });
        }
        pendingLeaveDiv.innerHTML = pendingLeaveHtml;
      }
      
      // Function to get the current list of emails from the selection state
      function saveMyTeam() {
        const selectedUsers = currentDashboardSelection.emails;
        
        if (selectedUsers.length === 0) {
          setStatus('dashboard-status', 'error', 'No specific users selected to save as your team.');
          return;
        }
        
        setStatus('dashboard-status', 'processing', 'Saving current selection as "My Team"...');
        
        google.script.run
          .withSuccessHandler(msg => {
            setStatus('dashboard-status', 'success', msg);
          })
          .withFailureHandler(err => {
            setStatus('dashboard-status', 'error', err.message);
          })
          .webSaveMyTeam(selectedUsers);
      }
      
      function loadMyTeam(autoLoadDashboard = false) { 
        setStatus('dashboard-status', 'processing', 'Loading "My Team"...');
        
        google.script.run
          .withSuccessHandler(teamEmails => {
            
            // Deselect all nodes in the tree
            document.querySelectorAll('#hierarchy-tree-view .tree-node').forEach(node => {
                node.classList.remove('selected');
            });

            if (teamEmails && teamEmails.length > 0) {
                const teamNames = teamEmails.map(email => {
                    const user = allUsersList.find(u => u.email === email);
                    return user ? user.name : null;
                }).filter(name => name);
                
                // Select the first node that is part of the saved team, just for visual feedback
                if(teamEmails[0]) {
                     const firstNode = document.querySelector(`#hierarchy-tree-view [data-email="${teamEmails[0]}"]`);
                     if (firstNode) firstNode.classList.add('selected');
                }
                
                currentDashboardSelection = {
                    emails: teamEmails,
                    name: `Saved Team (${teamEmails.length} users)`,
                    isFullHierarchy: false
                };
                
                document.getElementById('selected-user-display').textContent = currentDashboardSelection.name;
                setStatus('dashboard-status', 'success', 'Loaded "My Team". Click "Load Dashboard" to view.');
            } else {
                 currentDashboardSelection = { emails: [], name: "None", isFullHierarchy: false };
                 document.getElementById('selected-user-display').textContent = 'None';
                 setStatus('dashboard-status', 'success', 'No "My Team" saved. Select a user/team and click "Load Dashboard".');
            }
            
            if (autoLoadDashboard) {
              loadDashboard();
            }
          })
          .withFailureHandler(err => {
            setStatus('dashboard-status', 'error', err.message);
            if (autoLoadDashboard) {
              loadDashboard();
            }
          })
          .webGetMyTeam();
      }

     // --- Submit Movement Request (MODIFIED) ---
      function submitMovementRequest() {
        try {
          const userEmail = document.getElementById('reporting-line-user').value;
          const newSupervisorEmail = document.getElementById('reporting-line-supervisor').value;

          if (!userEmail) throw new Error("Please select a user to move.");
          if (!newSupervisorEmail) throw new Error("Please select a new supervisor.");
          if (userEmail === newSupervisorEmail) throw new Error("A user cannot be their own supervisor.");

          setStatus('movement-request-status', 'processing', 'Submitting movement request...');

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('movement-request-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('movement-request-status', 'success', msg);
                document.getElementById('reporting-line-form').reset();
                // Also refresh pending list, as the new request might appear
                loadPendingMovements();
              }
            })
            .withFailureHandler(err => {
              setStatus('movement-request-status', 'error', err.message);
            })
            .webSubmitMovementRequest(userEmail, newSupervisorEmail); // <-- MODIFIED Function Name

        } catch (err) {
          setStatus('movement-request-status', 'error', err.message);
        }
      }

      // --- NEW: Load Pending Movements ---
      function loadPendingMovements() {
        const listDiv = document.getElementById('pending-movements-list');
        listDiv.innerHTML = '<p class="text-color-secondary">Loading pending approvals...</p>';
        setStatus('movement-approval-status', '', ''); // Clear status

        google.script.run
          .withSuccessHandler(requests => {
            if (requests.error) {
              listDiv.innerHTML = `<p class="status-message error visible">${requests.error}</p>`;
              return;
            }
            if (requests.length === 0) {
              listDiv.innerHTML = '<p class="text-color-secondary">No pending approvals found.</p>';
              return;
            }

            let html = '';
            requests.forEach(req => {
              html += `
                <div class="request-list-item">
                  <div class="item-details">
                    <h4>Move: ${req.userToMoveName}</h4>
                    <p><strong>From:</strong> ${req.fromSupervisorName}</p>
                    <p><strong>To:</strong> ${req.toSupervisorName}</p>
                    <p class="text-color-secondary" style="font-size: 0.85rem;">Requested by ${req.requestedByName} on ${formatDate(req.requestedDate)}</p>
                  </div>
                  <div class="item-actions">
                    <button class="approve-btn" onclick="handleMovementApproval('${req.movementID}', 'Approved')">Approve</button>
                    <button class="deny-btn" onclick="handleMovementApproval('${req.movementID}', 'Denied')">Deny</button>
                  </div>
                </div>
              `;
            });
            listDiv.innerHTML = html;
          })
          .withFailureHandler(err => {
            listDiv.innerHTML = `<p class="status-message error visible">Error loading approvals: ${err.message}</p>`;
          })
          .webGetPendingMovements();
      }

      // --- NEW: Handle Movement Approval ---
      function handleMovementApproval(movementID, newStatus) {
        setStatus('movement-approval-status', 'processing', 'Processing request...');

        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              setStatus('movement-approval-status', 'error', result.error);
            } else {
              setStatus('movement-approval-status', 'success', result.message);
              loadPendingMovements(); // Refresh the list
            }
          })
          .withFailureHandler(err => {
            setStatus('movement-approval-status', 'error', err.message);
          })
          .webApproveDenyMovement(movementID, newStatus);
      }

      // --- NEW: Load Movement History ---
      function loadMovementHistory() {
        const listDiv = document.getElementById('movement-history-list');
        const userEmail = document.getElementById('movement-history-user').value;
        
        if (!userEmail) {
          setStatus('movement-history-status', 'error', 'Please select a user to view their history.');
          return;
        }

        listDiv.innerHTML = '<p class="text-color-secondary">Loading history...</p>';
        setStatus('movement-history-status', 'processing', 'Loading history...');

        google.script.run
          .withSuccessHandler(history => {
            if (history.error) {
              setStatus('movement-history-status', 'error', history.error);
              listDiv.innerHTML = '';
              return;
            }
            if (history.length === 0) {
              setStatus('movement-history-status', 'success', 'No movement history found for this user.');
              listDiv.innerHTML = '';
              return;
            }

            let html = '';
            history.forEach(item => {
              let statusClass = '';
              if (item.status === 'Pending') statusClass = 'status-pending';
              if (item.status === 'Approved') statusClass = 'status-approved';
              if (item.status === 'Denied') statusClass = 'status-denied';

              html += `
                <div class="request-list-item">
                  <div class="item-details">
                    <p><strong>From:</strong> ${item.fromSupervisorName}</p>
                    <p><strong>To:</strong> ${item.toSupervisorName}</p>
                    <p class="text-color-secondary">Requested: ${formatDate(item.requestDate)} by ${item.requestedByName}</p>
                    ${item.status !== 'Pending' ? `
                      <p class="text-color-secondary" style="font-size: 0.9rem;">
                        <strong>Action:</strong> ${formatDate(item.actionDate)} by ${item.actionByName}
                      </p>
                    ` : ''}
                  </div>
                  <div class="item-actions">
                    <span class="status-badge ${statusClass}">${item.status}</span>
                  </div>
                </div>
              `;
            });
            listDiv.innerHTML = html;
            setStatus('movement-history-status', 'success', `Loaded ${history.length} records.`);
          })
          .withFailureHandler(err => {
            setStatus('movement-history-status', 'error', err.message);
            listDiv.innerHTML = '';
          })
          .webGetMovementHistory(userEmail);
      }

      // --- NEW: Coaching Functions ---

     
      
      const scoreOptions = [
        { text: "-- Select Score --", value: "null" },
        { text: "Got It (100%)", value: "1" },
        { text: "Getting There or Could be Better (50%)", value: "0.5" },
        { text: "Missed It (0%)", value: "0" }
      ];

      // *** NEW: Store last coaching data for export ***
      let lastCoachingData = [];

      /**
       * Calculates ISO week number.
       */
      function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        return weekNo;
      }

      /**
       * Updates the week number input when the date changes.
       */
      function updateWeekNumber() {
        const dateInput = document.getElementById('coaching-session-date');
        const weekInput = document.getElementById('coaching-week-number');
        if (dateInput.value) {
          const date = new Date(dateInput.value);
          // Adjust for local timezone offset to get correct UTC date for week calculation
          const userTimezoneOffset = date.getTimezoneOffset() * 60000;
          const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
          weekInput.value = 'Week ' + getWeekNumber(adjustedDate);
        } else {
          weekInput.value = '';
        }
      }

      /**
       * NEW: Dynamically builds the QA form from template data.
       */
      function populateCoachingForm(categories) {
        const formDiv = document.getElementById('quality-score-form');
        if (!formDiv) return;
        
        // Check for error or empty
        if (!categories || categories.length === 0) {
          formDiv.innerHTML = `<p class="status-message error visible">Could not load criteria for this template. Please check the 'CoachingTemplates' sheet.</p>`;
          calculateOverallScore(); // Reset score to N/A
          return;
        }
        
        let html = '';
        categories.forEach((cat, catIndex) => {
          html += `<div class="qa-category"><h4>${cat.category}</h4>`;
          
          cat.criteria.forEach((crit, critIndex) => {
            // We use the same ID structure as before so calculateOverallScore()
            // and submitNewCoaching() still work perfectly.
            html += `
              <div class="qa-criterion">
                <p>${crit}</p>
                <div class="qa-criterion-inputs">
                  <select id="qa-score-${catIndex}-${critIndex}" onchange="calculateOverallScore()">
                    ${scoreOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                  </select>
                  <textarea id="qa-comment-${catIndex}-${critIndex}" placeholder="Enter comments..."></textarea>
                </div>
              </div>
            `;
          });
          html += `</div>`;
        });
        formDiv.innerHTML = html;
        calculateOverallScore(); // Recalculate (which resets it)
      }


      /**
       * (REPLACED)
       * Calculates and displays the overall QA score by reading the dynamic form.
       */
      function calculateOverallScore() {
        let totalScore = 0;
        let totalPossible = 0;
        
        // Find all score <select> elements in the dynamic form
        const scoreSelects = document.querySelectorAll('#quality-score-form select[id^="qa-score-"]');
        
        scoreSelects.forEach(select => {
          if (select.value !== "null") {
            totalScore += parseFloat(select.value);
            totalPossible += 1; // Each item is worth 1 point max
          }
        });
        
        const scoreSpan = document.getElementById('coaching-overall-score');
        if (totalPossible === 0) {
          scoreSpan.textContent = 'N/A';
          return { score: 0, possible: 0, percentage: 0 };
        } else {
          const percentage = (totalScore / totalPossible) * 100;
          scoreSpan.textContent = `${percentage.toFixed(2)}%`;
          return { score: totalScore, possible: totalPossible, percentage: percentage };
        }
      }

      /**
       * Called when the 'Coaching' tab is clicked.
       */
      function loadMyCoaching() {
        setStatus('coaching-list-status', 'processing', 'Loading coaching history...');
        // *** NEW: Hide export button while loading ***
        document.getElementById('export-coaching-btn').style.display = 'none';
        lastCoachingData = [];
        
        google.script.run
          .withSuccessHandler(populateMyCoaching)
          .withFailureHandler(err => {
            setStatus('coaching-list-status', 'error', err.message);
          })
          .webGetCoachingHistory(null);
      }

      /**
       * Renders the list of past coaching sessions.
       */
      function populateMyCoaching(sessions) {
        const listDiv = document.getElementById('coaching-list');
        if (sessions.error) {
          listDiv.innerHTML = `<p class="status-message error visible">${sessions.error}</p>`;
          setStatus('coaching-list-status', '', '');
          return;
        }
        if (!sessions || sessions.length === 0) {
          listDiv.innerHTML = '<p class="text-color-secondary">No coaching history found.</p>';
          setStatus('coaching-list-status', '', '');
          return;
        }
        
        // *** NEW: Store data for export and show button ***
        lastCoachingData = sessions;
        document.getElementById('export-coaching-btn').style.display = 'inline-block';
        
        let html = '';
        // Sort by session date, newest first
        sessions.sort((a, b) => new Date(b.sessionDate) - new Date(a.sessionDate));
        
        sessions.forEach(session => {
          let scoreDisplay = 'N/A';
          if (session.overallScore) {
             scoreDisplay = `${parseFloat(session.overallScore).toFixed(2)}%`;
          }
          
          let fuDate = session.followUpDate ? formatDate(session.followUpDate) : 'N/A';
          let fuStatus = session.followUpStatus || '';
          let fuHtml = '';

          // *** NEW: Better Follow-up Status Display ***
          if (fuStatus === 'Pending') {
            fuHtml = `<p><strong>Follow-up:</strong> <span class="status-badge status-pending" style="margin-top:0;">Pending (${fuDate})</span></p>`;
          } else if (fuStatus === 'Completed') {
            fuHtml = `<p><strong>Follow-up:</strong> <span class="status-badge status-approved" style="margin-top:0;">Completed (${fuDate})</span></p>`;
          } else if (fuStatus) { // e.g., "Postponed"
            fuHtml = `<p><strong>Follow-up:</strong> <span class="status-badge status-processing" style="margin-top:0;">${fuStatus} (${fuDate})</span></p>`;
          }
          // ********************************************

          // *** THIS IS THE SINGLE, CORRECTED BLOCK FOR THE BADGE ***
          let ackHtml = '';
          if (session.agentAcknowledgementTimestamp) {
            ackHtml = `<span class="status-badge status-approved" style="margin-left: 10px; font-size: 0.75rem; padding: 4px 8px;">Acknowledged</span>`;
          }
          // *** THE DUPLICATE BLOCK THAT WAS HERE IS NOW REMOVED ***

          html += `
            <div class="request-list-item">
              <div class="item-details">
                <h4>${session.agentName} - ${formatDate(session.sessionDate)} (${session.weekNumber}) ${ackHtml}</h4>
                <p><strong>Coach:</strong> ${session.coachName}</p>
                <p><strong>Overall Score:</strong> <strong style="color:var(--konecta-dark);">${scoreDisplay}</strong></p>
                ${session.followUpComment ?
                  `<p><strong>Comments:</strong> ${session.followUpComment}</p>` : ''}
                ${fuHtml} </div>
              <div class="item-actions">
                 <button type="button" class="view-btn" style="background-color: var(--konecta-blue); min-width: 120px;" 
                         onclick="showCoachingDetails('${session.sessionID}')">View Details</button>
              </div>
            </div>
          `;
        });
        
        listDiv.innerHTML = html;
        setStatus('coaching-list-status', '', ''); // Clear loading message
      }
      
      /**
       * *** NEW: Export Coaching History (Summary) ***
       */
      function exportCoachingHistory() {
        if (!lastCoachingData || lastCoachingData.length === 0) {
          setStatus('coaching-list-status', 'error', "No data to export.");
          return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "SessionID,AgentName,CoachName,SessionDate,WeekNumber,OverallScore,FollowUpComment,FollowUpDate,FollowUpStatus\r\n";
        
        lastCoachingData.forEach(session => {
          // Escape commas and quotes in comments
          const comment = `"${(session.followUpComment || "").replace(/"/g, '""')}"`;
          
          let row = [
            session.sessionID,
            session.agentName,
            session.coachName,
            formatDate(session.sessionDate),
            session.weekNumber,
            session.overallScore || 'N/A',
            comment,
            session.followUpDate ? formatDate(session.followUpDate) : 'N/A',
            session.followUpStatus || 'N/A'
          ].join(",");
          csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Coaching_History_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      }

      /**
       * NEW: Loads the list of active template names into the dropdown.
       */
      function loadTemplateList() {
        const templateSelect = document.getElementById('coaching-template-select');
        
        google.script.run
          .withSuccessHandler(templates => {
            if (templates.error) {
              console.error(templates.error);
              return;
            }
            
            // Clear all but the first option
            while (templateSelect.options.length > 1) {
              templateSelect.remove(1);
            }
            
            templates.forEach(templateName => {
              const option = document.createElement('option');
              option.value = templateName;
              option.textContent = templateName;
              templateSelect.appendChild(option);
            });
            
          })
          .withFailureHandler(err => {
            console.error("Failed to load templates: " + err.message);
          })
          .webGetActiveTemplates();
      }

      /**
       * NEW: Triggered by the template dropdown. Fetches criteria and builds form.
       */
      function loadCoachingForm() {
        const templateName = document.getElementById('coaching-template-select').value;
        const formDiv = document.getElementById('quality-score-form');
        
        if (!templateName) {
          formDiv.innerHTML = ''; // Clear the form
          calculateOverallScore(); // Reset score
          return;
        }

        formDiv.innerHTML = '<p class="text-color-secondary">Loading coaching form...</p>';
        
        google.script.run
          .withSuccessHandler(populateCoachingForm) // Re-use our new function
          .withFailureHandler(err => {
            formDiv.innerHTML = `<p class="status-message error visible">Error: ${err.message}</p>`;
          })
          .webGetTemplateCriteria(templateName);
      }

      /**
       * (REPLACED)
       * Submits the new coaching session form by reading the dynamic form.
       */
      function submitNewCoaching() {
        try {
          // Get user data
          const agentSelect = document.getElementById('coaching-agent-select');
          const selectedEmail = agentSelect.value;
          if (!selectedEmail) throw new Error("Please select an agent.");
          
          const templateName = document.getElementById('coaching-template-select').value;
          if (!templateName) throw new Error("Please select a coaching template.");
          
          const sessionDate = document.getElementById('coaching-session-date').value;
          if (!sessionDate) throw new Error("Please select a session date.");
          
          const weekNumber = document.getElementById('coaching-week-number').value;
          const followUpComment = document.getElementById('coaching-follow-up').value;
          const followUpDate = document.getElementById('coaching-follow-up-date').value;

          // Gather scores by reading the dynamic form
          const scores = [];
          // Find all category blocks
          const categoryBlocks = document.querySelectorAll('#quality-score-form .qa-category');
          
          categoryBlocks.forEach((catBlock, catIndex) => {
            const categoryName = catBlock.querySelector('h4').textContent;
            
            // Find all criteria within this category
            const criteriaBlocks = catBlock.querySelectorAll('.qa-criterion');
            
            criteriaBlocks.forEach((critBlock, critIndex) => {
              const criteriaName = critBlock.querySelector('p').textContent;
              const score = document.getElementById(`qa-score-${catIndex}-${critIndex}`).value;
              const comment = document.getElementById(`qa-comment-${catIndex}-${critIndex}`).value;
              
              // Only save if a score was selected
              if (score !== "null") {
                scores.push({
                  category: categoryName,
                  criteria: criteriaName,
                  score: parseFloat(score),
                  comment: comment
                });
              }
            });
          });
          
          // Calculate final score
          const { percentage } = calculateOverallScore();
          
          const sessionObject = {
            agentEmail: selectedEmail,
            sessionDate: sessionDate,
            weekNumber: weekNumber,
            scores: scores,
            followUpComment: followUpComment,
            overallScore: percentage,
            followUpDate: followUpDate || null 
          };
          
          setStatus('coaching-submit-status', 'processing', `Saving session for ${agentSelect.options[agentSelect.selectedIndex].text}...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('coaching-submit-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('coaching-submit-status', 'success', msg);
                
                // Reset form
                document.getElementById('coaching-agent-select').selectedIndex = 0;
                document.getElementById('coaching-template-select').selectedIndex = 0;
                document.getElementById('coaching-follow-up').value = '';
                document.getElementById('coaching-follow-up-date').value = '';
                document.getElementById('coaching-session-date').valueAsDate = new Date();
                
                updateWeekNumber();
                document.getElementById('quality-score-form').innerHTML = ''; // Clear dynamic form
                calculateOverallScore(); // Resets score display
                loadMyCoaching(); // Refresh the history list
              }
            })
            .withFailureHandler(err => {
              setStatus('coaching-submit-status', 'error', err.message);
            })
            .webSubmitCoaching(sessionObject);
        } catch (err) {
          setStatus('coaching-submit-status', 'error', err.message);
        }
      }
      
      

      // --- NEW: Coaching Detail Modal Functions ---

      let currentCoachingDetail = null; // Stores details for export

      function showCoachingDetails(sessionID) {
        // --- NEW: Debugging ---
        console.log("Attempting to load details for SessionID:", sessionID);
        if (!sessionID) {
          console.error("SessionID is undefined! Aborting.");
          return;
        }
        // --- End Debugging ---

        // 1. Show the modal
        document.getElementById('coaching-detail-modal-backdrop').style.display = 'block';
        document.getElementById('coaching-detail-modal').style.display = 'flex';
        
        // 2. Reset modal state
        const modalBody = document.getElementById('coaching-detail-modal-body');
        modalBody.innerHTML = '<p class="text-color-secondary">Loading details...</p>';
        document.getElementById('coaching-detail-export-btn').style.display = 'none';
        currentCoachingDetail = null;

        // 3. Fetch data
        google.script.run
          .withSuccessHandler(populateCoachingDetails)
          .withFailureHandler(err => {
            // --- NEW: Better Error Logging ---
            console.error("google.script.run FAILED:", err);
            modalBody.innerHTML = `<p class="status-message error visible">Error: ${err.message || 'The server call failed. Check the console (F12) for details.'}</p>`;
            // --- End Better Logging ---
          })
          .webGetCoachingSessionDetails(sessionID);
      }

      function closeCoachingDetails() {
        document.getElementById('coaching-detail-modal-backdrop').style.display = 'none';
        document.getElementById('coaching-detail-modal').style.display = 'none';
        document.getElementById('coaching-detail-modal-body').innerHTML = '';
        currentCoachingDetail = null;
      }

      function populateCoachingDetails(details) {
        // *** Add robust check for null/undefined ***
        if (!details) {
          document.getElementById('coaching-detail-modal-body').innerHTML = `<p class="status-message error visible">Error: Received no details from the server. The data might be corrupted or the server function failed silently.</p>`;
          return;
        }

        if (details.error) {
          document.getElementById('coaching-detail-modal-body').innerHTML = `<p class="status-message error visible">Error: ${details.error}</p>`;
          return;
        }

        currentCoachingDetail = details; // Save for export
        const summary = details.summary;
        const scores = details.scores;

        let scoreDisplay = summary.OverallScore ? `${parseFloat(summary.OverallScore).toFixed(2)}%` : 'N/A';
        let fuDate = summary.FollowUpDate ? formatDate(summary.FollowUpDate) : 'N/A';

        // *** NEW: Agent Acknowledgement Section ***
        let agentAckSection = '';
        if (selfRole === 'agent') {
          agentAckSection = `<hr class="section-divider"><div class="form-container" style="padding: 0;">`;
          
          if (summary.AgentAcknowledgementTimestamp) {
            // Agent has already acknowledged
            agentAckSection += `
              <div class="form-group" style="text-align: center;">
                <p style="font-size: 1.1rem; margin: 0;"><strong>Session Acknowledged</strong></p>
                <small class="text-color-secondary">on ${formatDate(summary.AgentAcknowledgementTimestamp)} at ${formatTime(summary.AgentAcknowledgementTimestamp)}</small>
              </div>
            `;
          } else {
            // Agent needs to acknowledge
            agentAckSection += `
              <div id="acknowledgement-status" class="status-message" style="margin-top: 0; margin-bottom: 15px;"></div>
              <p class="text-color-secondary" style="text-align: center; margin-top: 0;">Please review your coaching details and click below to confirm you have read and understood the session.</p>
              <button type="button" class="submit-btn-green" style="width: 100%; margin: 0;"
                      onclick="submitCoachingAcknowledgement('${summary.SessionID}')">Acknowledge Coaching Session</button>
            `;
          }
          agentAckSection += `</div>`;
        }
        // *** END NEW SECTION ***


        // *** Admin Follow-up Management Section ***
        let adminSection = '';
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          adminSection = `
            <hr class="section-divider">
            <h3 style="color: var(--konecta-blue); margin-top: 0;">Manage Follow-up</h3>
            <div class="form-container" style="padding: 0;">
              <div id="follow-up-status" class="status-message" style="margin-top: 0; margin-bottom: 15px;"></div>
              <div id="follow-up-controls" class="form-row" style="align-items: flex-end;">
                <div class="form-group">
                  <label for="follow-up-postpone-date">Postpone Date</label>
                  <input type="date" id="follow-up-postpone-date">
                </div>
                <div class="form-group">
                  <button type="button" class="view-btn" style="background-color: var(--status-pending-text); width: 100%; margin: 0;"
                          onclick="updateFollowUpStatus('${summary.SessionID}', 'Postponed')">Postpone</button>
                </div>
                <div class="form-group">
                  <button type="button" class="submit-btn-green" style="width: 100%; margin: 0;"
                          onclick="updateFollowUpStatus('${summary.SessionID}', 'Completed')">Mark Completed</button>
                </div>
              </div>
            </div>
          `;
        }
        // *** END SECTION ***


        let html = `
          <div class="dashboard-detail-item" style="background: var(--page-bg); grid-template-columns: 1fr 2fr; gap: 8px 15px;">
            <span class="detail-label">Agent:</span>
            <span class="detail-value" style="text-align: left;">${summary.AgentName}</span>
            
            <span class="detail-label">Coach:</span>
            <span class="detail-value" style="text-align: left;">${summary.CoachName}</span>
            
            <span class="detail-label">Session Date:</span>
            <span class="detail-value" style="text-align: left;">${formatDate(summary.SessionDate)} (${summary.WeekNumber})</span>
            
            <span class="detail-label">Overall Score:</span>
            <span class="detail-value" style="text-align: left; font-size: 1.1rem; color: var(--konecta-dark);">${scoreDisplay}</span>
            
            <span class="detail-label">Follow-up Date:</span>
            <span class="detail-value" style="text-align: left;">${fuDate}</span>
            
            <span class="detail-label">Follow-up Status:</span>
            <span class="detail-value" style="text-align: left;">${summary.FollowUpStatus || 'N/A'}</span>
            
            <span class="detail-label" style="grid-column: 1 / -1; margin-top: 10px;"><strong>Coach Comments:</strong></span>
            <p style="grid-column: 1 / -1; margin: 0; white-space: pre-wrap;">${summary.FollowUpComment || 'No comments provided.'}</p>
          </div>
          
          ${agentAckSection}

          ${adminSection}
          
          <hr class="section-divider">
          
          <h3 style="color: var(--konecta-blue); margin-top: 0;">Detailed Scores</h3>
        `;

        // Group scores by category
        const categories = {};
        scores.forEach(score => {
          if (!categories[score.Category]) {
            categories[score.Category] = [];
          }
          categories[score.Category].push(score);
        });

        // Build HTML for each category
        for (const categoryName in categories) {
          html += `
            <div class="qa-category" style="margin-top: 15px;">
              <h4>${categoryName}</h4>
              ${categories[categoryName].map(item => `
                <div class="qa-criterion">
                  <p style="margin: 0 0 10px 0;">${item.Criteria}</p>
                  <div style="display: flex; gap: 15px; align-items: flex-start;">
                    <span class="status-badge status-approved" style="background-color: var(--konecta-dark); color: white; padding: 8px 15px; min-width: 80px; text-align: center;">Score: ${item.Score}</span>
                    <textarea readonly style="flex: 1; height: 60px; min-height: 40px; background: var(--card-bg);">${item.Comment || 'N/A'}</textarea>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        document.getElementById('coaching-detail-modal-body').innerHTML = html;
        document.getElementById('coaching-detail-export-btn').style.display = 'inline-block';
        
        // Set postpone date input to today
        if (selfRole === 'admin' || selfRole === 'superadmin') {
          const postponeDateEl = document.getElementById('follow-up-postpone-date');
          if (postponeDateEl) {
            postponeDateEl.valueAsDate = new Date();
          }
        }
      }
      
      /**
       * NEW: Export Individual Coaching Session Details
       */
      function exportSessionDetails() {
        if (!currentCoachingDetail) {
          alert("No coaching details are loaded to export.");
          return;
        }

        const summary = currentCoachingDetail.summary;
        const scores = currentCoachingDetail.scores;

        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Add Summary
        csvContent += "Session Summary\r\n";
        csvContent += `SessionID,"${summary.SessionID}"\r\n`;
        csvContent += `Agent,"${summary.AgentName}"\r\n`;
        csvContent += `Coach,"${summary.CoachName}"\r\n`;
        csvContent += `Date,"${formatDate(summary.SessionDate)}"\r\n`;
        csvContent += `Week,"${summary.WeekNumber}"\r\n`;
        csvContent += `Overall Score,"${summary.OverallScore || 'N/A'}"\r\n`;
        csvContent += `Follow-up Date,"${summary.FollowUpDate ? formatDate(summary.FollowUpDate) : 'N/A'}"\r\n`;
        csvContent += `Follow-up Status,"${summary.FollowUpStatus || 'N/A'}"\r\n`;
        csvContent += `Comments,"${(summary.FollowUpComment || '').replace(/"/g, '""')}"\r\n`;
        
        // Add Spacer
        csvContent += "\r\nDetailed Scores\r\n";
        
        // Add Detail Headers
        csvContent += "Category,Criteria,Score,Comment\r\n";

        // Add Detail Rows
        scores.forEach(item => {
          const category = `"${item.Category.replace(/"/g, '""')}"`;
          const criteria = `"${item.Criteria.replace(/"/g, '""')}"`;
          const score = item.Score;
          const comment = `"${(item.Comment || '').replace(/"/g, '""')}"`;
          csvContent += [category, criteria, score, comment].join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Coaching_Detail_${summary.AgentName}_${formatDate(summary.SessionDate)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function updateFollowUpStatus(sessionID, newStatus) {
        let newDate = null;
        
        if (newStatus === 'Postponed') {
          newDate = document.getElementById('follow-up-postpone-date').value;
          if (!newDate) {
            setStatus('follow-up-status', 'error', 'Please select a date to postpone to.');
            return;
          }
        }
        
        // Show processing status inside the modal
        setStatus('follow-up-status', 'processing', 'Updating status...');

        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              setStatus('follow-up-status', 'error', result.error);
            } else {
              setStatus('follow-up-status', 'success', result.message);
              // Refresh the main list
              loadMyCoaching();
              // Re-fetch details for the modal to show updated info
              showCoachingDetails(sessionID);
            }
          })
          .withFailureHandler(err => {
            setStatus('follow-up-status', 'error', err.message);
          })
          .webUpdateFollowUpStatus(sessionID, newStatus, newDate);
      }

      function submitCoachingAcknowledgement(sessionID) {
        // Show processing status inside the modal
        setStatus('acknowledgement-status', 'processing', 'Submitting acknowledgement...');

        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              setStatus('acknowledgement-status', 'error', result.error);
            } else if (result.success === false) {
              setStatus('acknowledgement-status', 'error', result.message);
            } else {
              setStatus('acknowledgement-status', 'success', result.message);
              // Refresh the main list
              loadMyCoaching();
              // Re-fetch details for the modal to show the updated status
              showCoachingDetails(sessionID);
            }
          })
          .withFailureHandler(err => {
            setStatus('acknowledgement-status', 'error', err.message);
          })
          .webSubmitCoachingAcknowledgement(sessionID);
      }


      // --- END Coaching Functions ---

      // [START] MODIFICATION 6: Add JS for Coaching Admin Tab

      let categoryCounter = 0;

      function addTemplateCategory() {
        categoryCounter++;
        const container = document.getElementById('template-categories-container');
        const newCategory = document.createElement('div');
        newCategory.className = 'template-category-block';
        newCategory.id = 'category-' + categoryCounter;
        newCategory.innerHTML = `
          <button type.="button" class="remove-category-btn" onclick="removeTemplateItem('category-${categoryCounter}')" title="Remove Category">&times;</button>
          <div class="form-group">
            <label for="category-name-${categoryCounter}">Category Name</label>
            <input type="text" id="category-name-${categoryCounter}" class="category-name-input" placeholder="e.g., 'Opening'">
          </div>
          <div class="template-criteria-container" id="criteria-container-${categoryCounter}">
            </div>
          <button type="button" class="view-btn" onclick="addTemplateCriteria(${categoryCounter})" style="background-color: var(--text-color-secondary); margin-top: 15px; padding: 8px 15px; font-size: 0.9rem;">+ Add Criteria</button>
        `;
        container.appendChild(newCategory);
      }

      function addTemplateCriteria(categoryIndex) {
        const container = document.getElementById('criteria-container-' + categoryIndex);
        const criteriaItem = document.createElement('div');
        criteriaItem.className = 'template-criteria-item';
        criteriaItem.innerHTML = `
          <input type="text" class="criteria-name-input" placeholder="e.g., 'Agent greeted customer'">
          <button type="button" class="remove-btn" onclick="removeTemplateItem(this.parentElement)">-</button>
        `;
        container.appendChild(criteriaItem);
      }

      function removeTemplateItem(elementOrId) {
        let elementToRemove;
        if (typeof elementOrId === 'string') {
          elementToRemove = document.getElementById(elementOrId);
        } else {
          elementToRemove = elementOrId;
        }
        if (elementToRemove) {
          elementToRemove.remove();
        }
      }

      function saveNewTemplate() {
        try {
          const templateName = document.getElementById('template-name').value.trim();
          if (!templateName) {
            throw new Error("Template Name is required.");
          }
          
          const categories = [];
          const categoryBlocks = document.querySelectorAll('.template-category-block');
          
          if (categoryBlocks.length === 0) {
            throw new Error("You must add at least one category.");
          }

          categoryBlocks.forEach(block => {
            const categoryName = block.querySelector('.category-name-input').value.trim();
            if (!categoryName) {
              throw new Error("All Category Names are required.");
            }
            
            const criteria = [];
            const criteriaInputs = block.querySelectorAll('.criteria-name-input');
            
            if (criteriaInputs.length === 0) {
              throw new Error(`Category '${categoryName}' must have at least one criterion.`);
            }
            
            criteriaInputs.forEach(input => {
              const criteriaName = input.value.trim();
              if (!criteriaName) {
                throw new Error("All Criteria fields are required.");
              }
              criteria.push(criteriaName);
            });
            
            categories.push({ name: categoryName, criteria: criteria });
          });
          
          setStatus('coaching-admin-status', 'processing', `Saving template '${templateName}'...`);
          
          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) { 
                setStatus('coaching-admin-status', 'error', msg.replace('Error: ', ''));
              } else {
                setStatus('coaching-admin-status', 'success', msg);
                // Reset form
                document.getElementById('template-create-form').reset();
                document.getElementById('template-categories-container').innerHTML = '';
                categoryCounter = 0;
                // Reload the template list in the *other* tab
                loadTemplateList();
              }
            })
            .withFailureHandler(err => {
              setStatus('coaching-admin-status', 'error', err.message);
            })
            .webSaveNewTemplate(templateName, categories);

        } catch (err) {
          setStatus('coaching-admin-status', 'error', err.message);
        }
      }
// [END] MODIFICATION 6


      // *** START: NEW SUPERVISOR MODAL FUNCTIONS ***
      function showSupervisorModal(allAdmins) {
        const select = document.getElementById('supervisor-select');
        select.innerHTML = '<option value="">-- Select your supervisor --</option>';

        // Use the allAdminsList to populate the dropdown
        allAdmins.forEach(admin => {
          const option = document.createElement('option');
          option.value = admin.email;
          option.textContent = `${admin.name} (${admin.role})`;
          select.appendChild(option);
        });
        
        document.getElementById('supervisor-modal-backdrop').style.display = 'block';
        document.getElementById('supervisor-modal').style.display = 'flex';
      }

      /**
       * MODIFIED: Calls new function and shows message instead of reloading
       */
      function saveMySupervisor() {
        try {
          const supervisorEmail = document.getElementById('supervisor-select').value;
          if (!supervisorEmail) {
            throw new Error("Please select a supervisor from the list.");
          }

          setStatus('supervisor-save-status', 'processing', 'Saving submission...');

          google.script.run
            .withSuccessHandler(msg => {
              if (msg.startsWith('Error:')) {
                setStatus('supervisor-save-status', 'error', msg.replace('Error: ', ''));
              } else {
                // Success! Close modal and show message on main page.
                document.getElementById('supervisor-modal-backdrop').style.display = 'none';
                document.getElementById('supervisor-modal').style.display = 'none';
                
                // Show the "pending" message on the main panel
                document.getElementById('punch-panel').innerHTML = `
                  <h2 style="color: var(--konecta-blue);">Registration Pending</h2>
                  <p class="text-color-secondary">${msg}</p>
                  <p class="text-color-secondary">If your request is denied, you will be prompted to re-select a supervisor when you log in again.</p>
                `;
              }
            })
            .withFailureHandler(err => {
              setStatus('supervisor-save-status', 'error', err.message);
            })
            .webSubmitSupervisorSelection(supervisorEmail); // *** MODIFIED: Call new function ***

        } catch (err) {
          setStatus('supervisor-save-status', 'error', err.message);
        }
      }
      // *** END: NEW SUPERVISOR MODAL FUNCTIONS ***

      // *** START: REGISTRATION WORKFLOW FUNCTIONS ***

      /**
       * Called for pending users to see if they need to be prompted
       */
      function loadMyRegistrationStatus() {
        google.script.run
          .withSuccessHandler(result => {
            if (result.error) {
              console.error(result.error);
              return;
            }
            if (result.status === 'New' || result.status === 'Denied') {
              // User is pending but has no submission, or was denied.
              // Show the modal to (re-)submit.
              if(result.status === 'Denied') {
                 // Update modal text to show it was denied
                 document.getElementById('supervisor-modal').querySelector('p').innerText = 'Your previous supervisor selection was denied. Please select the correct supervisor from the list.';
              }
              showSupervisorModal(allAdminsList);
            }
            // If status is 'Pending', we do nothing. The main page message is already showing.
          })
          .webGetMyRegistrationStatus();
      }

      /**
       * Called by superadmin clicking the "Registration Admin" tab.
       */
      function loadRegistrationAdmin() {
        setStatus('registration-admin-status', 'processing', 'Loading pending registrations...');
        const listDiv = document.getElementById('registration-admin-list');
        listDiv.innerHTML = '';

        google.script.run
          .withSuccessHandler(requests => {
            if (requests.error) {
              setStatus('registration-admin-status', 'error', requests.error);
              return;
            }
            if (requests.length === 0) {
              setStatus('registration-admin-status', 'success', 'No new user registrations are pending.');
              return;
            }
            
            setStatus('registration-admin-status', 'success', `Loaded ${requests.length} pending requests.`);
            let html = '';
            
            // --- ADD THIS LINE ---
            const todayDateStr = new Date().toISOString().split('T')[0];

            requests.forEach(req => {
              html += `
                <div class="request-list-item">
                  <div class="item-details">
                    <h4>${req.userName}</h4>
                    <p><strong>Email:</strong> ${req.userEmail}</p>
                    <p><strong>Selected Supervisor:</strong> ${req.supervisorName}</p>
                    <p class="text-color-secondary"><strong>Submitted:</strong> ${formatDate(req.timestamp)}</p>
                    
                    <div class="form-group" style="margin: 15px 0 0 0;">
                      <label for="hiring-date-${req.requestID}" style="font-weight: 600;">Hiring Date:</label>
                      <input type="date" id="hiring-date-${req.requestID}" value="${todayDateStr}" style="padding: 8px; background-color: var(--card-bg);">
                    </div>
                    </div>
                  <div class="item-actions">
                    <button class="approve-btn" onclick="approveDenyRegistration('${req.requestID}', '${req.userEmail}', '${req.selectedSupervisorEmail}', 'Approved', 'hiring-date-${req.requestID}')">Approve</button>
                    <button class="deny-btn" onclick="approveDenyRegistration('${req.requestID}', '${req.userEmail}', '${req.selectedSupervisorEmail}', 'Denied', null)">Deny</button>
                  </div>
                </div>
              `;
            });
            listDiv.innerHTML = html;
          })
          .withFailureHandler(err => {
            setStatus('registration-admin-status', 'error', err.message);
          })
          .webGetPendingRegistrations();
      }

      // REPLACE this function in your <script> tag
function approveDenyRegistration(requestID, userEmail, supervisorEmail, newStatus, dateInputId) { // <-- Added dateInputId
  
  // This is the backend call. It's the same.
  const runAction = (hiringDateStr) => {
    setStatus('registration-admin-status', 'processing', `Processing ${newStatus} for ${userEmail}...`);

    google.script.run
      .withSuccessHandler(result => {
        if (result.error) {
          setStatus('registration-admin-status', 'error', result.error);
        } else {
          setStatus('registration-admin-status', 'success', result.message);
          loadRegistrationAdmin(); // Refresh the list
        }
      })
      .withFailureHandler(err => {
        setStatus('registration-admin-status', 'error', err.message);
      })
      // *** MODIFIED: Pass hiringDateStr ***
      .webApproveDenyRegistration(requestID, userEmail, supervisorEmail, newStatus, hiringDateStr);
  };

  if (newStatus === 'Approved') {
    // *** MODIFIED: Read from calendar, remove prompt ***
    const hiringDateStr = document.getElementById(dateInputId).value;
    
    if (!hiringDateStr) {
      setStatus('registration-admin-status', 'error', 'Please select a Hiring Date from the calendar.');
      return; // User clicked approve without a date
    }
    
    // Simple validation (can be removed if not needed, as <input type="date"> is robust)
    if (!/^\d{4}-\d{2}-\d{2}$/.test(hiringDateStr) || isNaN(new Date(hiringDateStr).getTime())) {
      setStatus('registration-admin-status', 'error', 'Invalid date format. Please use YYYY-MM-DD.');
      return;
    }
    
    // Show confirmation
    showCustomConfirm(
      `Are you sure you want to APPROVE ${userEmail} with hiring date ${hiringDateStr}?`,
      'Approve User',
      'approve-btn',
      () => runAction(hiringDateStr) // Pass date to action
    );
    
  } else {
    // Denying, no date needed, logic is unchanged
    showCustomConfirm(
      `Are you sure you want to DENY ${userEmail}? They will be prompted to re-select a supervisor.`,
      'Deny User',
      'deny-btn',
      () => runAction(null) // Pass null for date
    );
  }
}
      
      // *** END: REGISTRATION WORKFLOW FUNCTIONS ***
      // *** START: CUSTOM CONFIRM MODAL FUNCTIONS ***
      
      // A variable to hold the callback function
      let _onConfirmCallback = null;

      function showCustomConfirm(message, confirmText = 'Confirm', confirmClass = 'submit-btn-green', onConfirm = null) {
        // Set modal content
        document.getElementById('confirm-modal-message').innerText = message;
        
        const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
        confirmBtn.innerText = confirmText;
        
        // Set button style (e.g., 'deny-btn' for red, 'submit-btn-green' for green)
        confirmBtn.className = ''; // Reset classes
        confirmBtn.classList.add(confirmClass); // Add the specific class
        
        // Store the callback
        _onConfirmCallback = onConfirm;

        // Set the click handler for the confirm button
        confirmBtn.onclick = () => {
          if (typeof _onConfirmCallback === 'function') {
            _onConfirmCallback();
          }
          hideCustomConfirm();
        };

        // Show the modal
        document.getElementById('confirm-modal-backdrop').style.display = 'block';
        document.getElementById('confirm-modal').style.display = 'flex';
      }

      function hideCustomConfirm() {
        document.getElementById('confirm-modal-backdrop').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'none';
        _onConfirmCallback = null; // Clear the callback
      }
      // *** END: CUSTOM CONFIRM MODAL FUNCTIONS ***

      // *** ADD THESE FUNCTIONS ***
      function showRoleRequestModal() {
        // Reset form status
        setStatus('admin-request-status', '', '');
        document.getElementById('admin-request-form').reset();
        document.getElementById('role-request-modal-backdrop').style.display = 'block';
        document.getElementById('role-request-modal').style.display = 'flex';
      }

      function hideRoleRequestModal() {
        document.getElementById('role-request-modal-backdrop').style.display = 'none';
        document.getElementById('role-request-modal').style.display = 'none';
      }

      function showRoleApprovalModal() {
  // This is the Superadmin modal
  document.getElementById('role-approval-modal-backdrop').style.display = 'block';
  document.getElementById('role-approval-modal').style.display = 'flex';
  loadRoleRequests(); // Load the list of requests
}

function hideRoleApprovalModal() {
  document.getElementById('role-approval-modal-backdrop').style.display = 'none';
  document.getElementById('role-approval-modal').style.display = 'none';
}

function loadRoleRequests() {
  setStatus('role-approval-status', 'processing', 'Loading pending requests...');
  const listDiv = document.getElementById('role-request-list');
  listDiv.innerHTML = '';

  google.script.run
    .withSuccessHandler(requests => {
      if (requests.error) {
        setStatus('role-approval-status', 'error', requests.error);
        return;
      }
      if (requests.length === 0) {
        listDiv.innerHTML = '<p class="text-color-secondary">No pending role requests.</p>';
        setStatus('role-approval-status', '', ''); // Clear loading
        // Remove notification badge
        document.getElementById('header-role-request-button').classList.remove('has-notification');
        return;
      }

      let html = '';
      requests.forEach(req => {
        html += `
          <div class="request-list-item">
            <div class="item-details">
              <h4>${req.userName}</h4>
              <p><strong>Email:</strong> ${req.userEmail}</p>
              <p><strong>Request:</strong> ${req.currentRole} ➔ <strong>${req.requestedRole}</strong></p>
              <p><strong>Justification:</strong> ${req.justification}</p>
              <p class="text-color-secondary"><strong>Submitted:</strong> ${formatDate(req.timestamp)}</p>
            </div>
            <div class="item-actions">
              <button class="approve-btn" onclick="approveDenyRoleRequest('${req.requestID}', 'Approved')">Approve</button>
              <button class="deny-btn" onclick="approveDenyRoleRequest('${req.requestID}', 'Denied')">Deny</button>
            </div>
          </div>
        `;
      });
      listDiv.innerHTML = html;
      setStatus('role-approval-status', 'success', `Loaded ${requests.length} requests.`);
    })
    .withFailureHandler(err => {
      setStatus('role-approval-status', 'error', err.message);
    })
    .webGetRoleRequests();
}

function approveDenyRoleRequest(requestID, newStatus) {
  const runAction = () => {
    setStatus('role-approval-status', 'processing', `Processing ${newStatus}...`);

    google.script.run
      .withSuccessHandler(result => {
        if (result.error) {
          setStatus('role-approval-status', 'error', result.error);
        } else {
          setStatus('role-approval-status', 'success', result.message);
          loadRoleRequests(); // Refresh the list
        }
      })
      .withFailureHandler(err => {
        setStatus('role-approval-status', 'error', err.message);
      })
      .webApproveDenyRoleRequest(requestID, newStatus);
  };

  // Show a confirmation before doing anything
  const message = newStatus === 'Approved' ? 'Are you sure you want to approve this role upgrade?' : 'Are you sure you want to deny this request?';
  const buttonClass = newStatus === 'Approved' ? 'submit-btn-green' : 'deny-btn';

  showCustomConfirm(message, newStatus, buttonClass, runAction);
}
// *** END OF NEW FUNCTIONS ***



      // ===================================
      // === ANNOUNCEMENTS MODULE (JS) ===
      // ===================================

// For users to see the banner
function loadAnnouncements() {
  google.script.run
    .withSuccessHandler(renderAnnouncementsBanner)
    .withFailureHandler(err => console.error("Failed to load announcements:", err))
    .webGetAnnouncements();
}

function renderAnnouncementsBanner(announcements) {
  const container = document.getElementById('announcement-banner-container');
  const contentArea = document.getElementById('announcement-content-area');
  
  if (announcements && announcements.length > 0) {
    // We removed the sessionStorage check here.
    
    // Using <pre> preserves line breaks from the textarea
    let html = announcements.map(a => 
      `<pre style="font-family: 'Inter', Arial, sans-serif; margin: 0 0 10px 0; white-space: pre-wrap;">- ${a.content}</pre>`
    ).join('');
    
    contentArea.innerHTML = html;
    container.style.display = 'block'; // Always show it if announcements exist
  } else {
    container.style.display = 'none';
  }
}

function dismissAnnouncements() {
  document.getElementById('announcement-banner-container').style.display = 'none';
  // We no longer set sessionStorage, so it will reappear on refresh
}

// For superadmins to manage them
function loadAnnouncements_Admin() {
  setStatus('announcement-admin-status', 'processing', 'Loading announcements...');
  google.script.run
    .withSuccessHandler(renderAnnouncementsAdmin)
    .withFailureHandler(err => setStatus('announcement-admin-status', 'error', err.message))
    .webGetAnnouncements_Admin();
}

function renderAnnouncementsAdmin(announcements) {
  const listDiv = document.getElementById('announcement-admin-list');
  if (announcements.error) {
    setStatus('announcement-admin-status', 'error', announcements.error);
    listDiv.innerHTML = '';
    return;
  }

  if (!announcements || announcements.length === 0) {
    listDiv.innerHTML = '<p class="text-color-secondary">No announcements found.</p>';
    setStatus('announcement-admin-status', '', '');
    return;
  }

  let html = '';
  // Sort by timestamp, newest first
  announcements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  announcements.forEach(a => {
    const statusClass = a.status === 'Active' ? 'status-approved' : 'status-pending';
    // Escape content for safe insertion into an HTML onclick attribute
    const escapedContent = a.content.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\r\n|\r|\n/g, '\\n');

    html += `
      <div class="request-list-item">
        <div class="item-details">
          <pre style="font-family: 'Inter', Arial, sans-serif; margin: 0; white-space: pre-wrap;">${a.content}</pre>
          <small class="text-color-secondary">By: ${a.createdBy} on ${formatDate(a.timestamp)}</small>
        </div>
        <div class="item-actions" style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end; min-width: 120px;">
          <span class="status-badge ${statusClass}">${a.status}</span>
          <div style="margin-top: 5px;">
            <button class="view-btn" style="background-color: var(--konecta-blue); padding: 5px 10px; font-size: 0.9rem; margin: 0 5px;" onclick="editAnnouncement('${a.id}', '${escapedContent}', '${a.status}')">Edit</button>
            <button class="deny-btn" style="padding: 5px 10px; font-size: 0.9rem; margin: 0;" onclick="deleteAnnouncement('${a.id}')">Delete</button>
          </div>
        </div>
      </div>
    `;
  });
  listDiv.innerHTML = html;
  setStatus('announcement-admin-status', '', '');
}

function clearAnnouncementForm() {
  document.getElementById('announcement-id').value = '';
  document.getElementById('announcement-content').value = '';
  document.getElementById('announcement-status').value = 'Active';
  setStatus('announcement-admin-status', '', '');
}

function editAnnouncement(id, content, status) {
  document.getElementById('announcement-id').value = id;
  // Handle escaped quotes and newlines from the onclick string
  const unescapedContent = content.replace(/&quot;/g, '"').replace(/\\n/g, '\n');
  document.getElementById('announcement-content').value = unescapedContent;
  document.getElementById('announcement-status').value = status;

  // Scroll to the top of the main container to show the form
  document.querySelector('main').scrollTo(0, 0); 
}

function saveAnnouncement() {
  const announcement = {
    id: document.getElementById('announcement-id').value || null,
    content: document.getElementById('announcement-content').value,
    status: document.getElementById('announcement-status').value
  };

  if (!announcement.content || announcement.content.trim() === "") {
    setStatus('announcement-admin-status', 'error', 'Content cannot be empty.');
    return;
  }

  setStatus('announcement-admin-status', 'processing', 'Saving...');

  google.script.run
    .withSuccessHandler(result => {
      if (result.error) {
        setStatus('announcement-admin-status', 'error', result.error);
      } else {
        setStatus('announcement-admin-status', 'success', 'Announcement saved!');
        clearAnnouncementForm();
        loadAnnouncements_Admin(); // Refresh admin list
        loadAnnouncements(); // Refresh user banner
      }
    })
    .withFailureHandler(err => setStatus('announcement-admin-status', 'error', err.message))
    .webSaveAnnouncement(announcement);
}

function deleteAnnouncement(id) {
  // Use the existing custom confirm modal
  showCustomConfirm(
    'Are you sure you want to permanently delete this announcement?',
    'Delete',
    'deny-btn',
    () => { // This is the onConfirm callback
      setStatus('announcement-admin-status', 'processing', 'Deleting...');
      google.script.run
        .withSuccessHandler(result => {
          if (result.error) {
            setStatus('announcement-admin-status', 'error', result.error);
          } else {
            setStatus('announcement-admin-status', 'success', 'Announcement deleted.');
            loadAnnouncements_Admin(); // Refresh admin list
            loadAnnouncements(); // Refresh user banner
          }
        })
        .withFailureHandler(err => setStatus('announcement-admin-status', 'error', err.message))
        .webDeleteAnnouncement(id);
    }
  );
}

      // Initialize
      document.addEventListener("DOMContentLoaded", function() {
        loadUserInfo(); 
        document.getElementById('schedule-start-date').valueAsDate = new Date();
        document.getElementById('leave-start-date').valueAsDate = new Date();
        document.getElementById('history-start-date').valueAsDate = new Date(); 
        document.getElementById('history-end-date').valueAsDate = new Date(); 
        document.getElementById('manual-punch-date').valueAsDate = new Date(); 
        document.getElementById('admin-leave-start-date').valueAsDate = new Date(); 
        document.getElementById('dashboard-date').valueAsDate = new Date();
        
        // NEW: Coaching form init
        document.getElementById('coaching-session-date').valueAsDate = new Date();
        document.getElementById('coaching-session-date').addEventListener('change', updateWeekNumber);
        loadTemplateList();
        updateWeekNumber();
        calculateOverallScore();

        toggleTimeFields();
      });
   </script>
    <div id="coaching-detail-modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 199;"></div>
    <div id="coaching-detail-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; max-height: 90vh; background-color: var(--card-bg); border-radius: var(--radius); z-index: 200; box-shadow: var(--shadow); overflow: hidden; flex-direction: column;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color);">
        <h2 style="margin: 0; font-size: 1.25rem; color: var(--konecta-blue);">Coaching Session Details</h2>
        <button onclick="closeCoachingDetails()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-color-secondary); padding: 0 10px; line-height: 1;">&times;</button>
      </div>
      
      <div id="coaching-detail-modal-body" style="padding: 20px; overflow-y: auto; flex-grow: 1;">
        <p class="text-color-secondary">Loading details...</p>
      </div>

      <div style="padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: var(--input-bg); text-align: right;">
        <button id="coaching-detail-export-btn" type="button" class="export-btn" style="display: none; margin: 0 10px; background-color: var(--text-color-secondary);" onclick="exportSessionDetails()">Export Details</button>
        <button type="button" onclick="closeCoachingDetails()" style="min-width: 100px; background-color: var(--konecta-dark);">Close</button>
      </div>
    </div>
  
<div id="supervisor-modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 299;"></div>
    <div id="supervisor-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background-color: var(--card-bg); border-radius: var(--radius); z-index: 300; box-shadow: var(--shadow); overflow: hidden; flex-direction: column;">
      
      <div style="padding: 20px 20px 15px 20px; border-bottom: 1px solid var(--border-color);">
        <h2 style="margin: 0; font-size: 1.25rem; color: var(--konecta-blue);">Welcome to KOMPASS !</h2>
      </div>
      
      <div style="padding: 20px; flex-grow: 1;">
        <p class="text-color-secondary">To complete your registration, please select your direct supervisor from the list below.</p>
        
        <div class="form-group">
          <label for="supervisor-select">Select Your Supervisor</label>
          <select id="supervisor-select" required>
            <option value="">-- Loading managers... --</option>
          </select>
        </div>

        <div id="supervisor-save-status" class="status-message" style="margin-top: 15px;"></div>
      </div>

      <div style="padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: var(--input-bg); text-align: right;">
        <button type="button" class="submit-btn-green" style="min-width: 120px;" onclick="saveMySupervisor()">Save and Continue</button>
      </div>
    </div>
    
    </div> 
    
    <div id="confirm-modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 399;"></div>
    <div id="confirm-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 450px; background-color: var(--card-bg); border-radius: var(--radius); z-index: 400; box-shadow: var(--shadow); overflow: hidden; flex-direction: column;">
      
      <div style="padding: 20px 20px 15px 20px;">
        <h2 id="confirm-modal-title" style="margin: 0; font-size: 1.25rem; color: var(--konecta-blue);">Confirm Action</h2>
      </div>
      
      <div style="padding: 0 20px 20px 20px; flex-grow: 1;">
        <p id="confirm-modal-message" class="text-color-secondary">Are you sure you want to do this?</p>
      </div>

      <div style="padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: var(--input-bg); text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
        <button id="confirm-modal-cancel-btn" type="button" class="view-btn" style="background-color: var(--text-color-secondary);" onclick="hideCustomConfirm()">Cancel</button>
        <button id="confirm-modal-confirm-btn" type="button" class="deny-btn">Confirm</button>
      </div>
    </div>

    <div id="role-request-modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 299;"></div>
    <div id="role-request-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background-color: var(--card-bg); border-radius: var(--radius); z-index: 300; box-shadow: var(--shadow); overflow: hidden; flex-direction: column;">
      
      <div style="padding: 20px 20px 15px 20px; border-bottom: 1px solid var(--border-color);">
        <h2 style="margin: 0; font-size: 1.25rem; color: var(--konecta-blue);">Request Role Upgrade</h2>
      </div>
      
      <div id="role-request-modal-body" style="padding: 20px; flex-grow: 1;">
        <form id="admin-request-form" class="form-container" style="padding: 0; box-shadow: none; border: none; background: none;">
          <p class="text-color-secondary">If your supervisor is a 'Superadmin', you can request 'Admin' access. If you are an 'Admin', you can request 'Superadmin' access. Requests will be reviewed by the system owner.</p>
          <div class="form-group">
            <label for="admin-request-role">Role to Request</label>
            <select id="admin-request-role">
              <option value="admin">Admin</option>
              <option value="superadmin">Superadmin</option>
            </select>
          </div>
          <div class="form-group">
            <label for="admin-request-justification">Justification</label>
            <textarea id="admin-request-justification" rows="3" placeholder="Please explain why you need this role upgrade." required></textarea>
          </div>
          <button type="button" class="view-btn" style="background-color:var(--konecta-dark); width: 100%; margin: 0;" onclick="submitAdminRequest()">Submit Role Request</button>
        </form>
        <div id="admin-request-status" class="status-message" style="margin-top: 15px;"></div>
      </div>

      <div style="padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: var(--input-bg); text-align: right;">
        <button type="button" class="view-btn" style="background-color: var(--text-color-secondary);" onclick="hideRoleRequestModal()">Close</button>
      </div>
    
      </div> <div id="role-approval-modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 299;"></div>
    <div id="role-approval-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; max-height: 90vh; background-color: var(--card-bg); border-radius: var(--radius); z-index: 300; box-shadow: var(--shadow); overflow: hidden; flex-direction: column;">

      <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color);">
        <h2 style="margin: 0; font-size: 1.25rem; color: var(--konecta-blue);">Pending Role Upgrade Requests</h2>
        <button onclick="hideRoleApprovalModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-color-secondary); padding: 0 10px; line-height: 1;">&times;</button>
      </div>

      <div id="role-approval-modal-body" style="padding: 20px; overflow-y: auto; flex-grow: 1;">
        <div id="role-approval-status" class="status-message"></div>
        <div id="role-request-list" class="request-list" style="padding-top: 0; margin-top: 0;">
          <p class="text-color-secondary">Loading requests...</p>
        </div>
      </div>

      <div style="padding: 15px 20px; border-top: 1px solid var(--border-color); background-color: var(--input-bg); text-align: right;">
        <button type="button" class="view-btn" style="background-color: var(--text-color-secondary);" onclick="hideRoleApprovalModal()">Close</button>
      </div>
    </div>
    
  </body>
</html>
